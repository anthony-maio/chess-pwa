var Nr=Object.defineProperty;var Kr=(e,t,n)=>t in e?Nr(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var O=(e,t,n)=>Kr(e,typeof t!="symbol"?t+"":t,n);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&r(s)}).observe(document,{childList:!0,subtree:!0});function n(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(i){if(i.ep)return;i.ep=!0;const o=n(i);fetch(i.href,o)}})();function qr(e){return e!==null?{comment:e,variations:[]}:{variations:[]}}function Dr(e,t,n,r,i){const o={move:e,variations:i};return t&&(o.suffix=t),n&&(o.nag=n),r!==null&&(o.comment=r),o}function Rr(...e){const[t,...n]=e;let r=t;for(const i of n)i!==null&&(r.variations=[i,...i.variations],i.variations=[],r=i);return t}function Fr(e,t){if(t.marker&&t.marker.comment){let n=t.root;for(;;){const r=n.variations[0];if(!r){n.comment=t.marker.comment;break}n=r}}return{headers:e,root:t.root,result:(t.marker&&t.marker.result)??void 0}}function Br(e,t){function n(){this.constructor=e}n.prototype=t.prototype,e.prototype=new n}function ke(e,t,n,r){var i=Error.call(this,e);return Object.setPrototypeOf&&Object.setPrototypeOf(i,ke.prototype),i.expected=t,i.found=n,i.location=r,i.name="SyntaxError",i}Br(ke,Error);function Xe(e,t,n){return n=n||" ",e.length>t?e:(t-=e.length,n+=n.repeat(t),e+n.slice(0,t))}ke.prototype.format=function(e){var t="Error: "+this.message;if(this.location){var n=null,r;for(r=0;r<e.length;r++)if(e[r].source===this.location.source){n=e[r].text.split(/\r\n|\n|\r/g);break}var i=this.location.start,o=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(i):i,s=this.location.source+":"+o.line+":"+o.column;if(n){var l=this.location.end,c=Xe("",o.line.toString().length," "),a=n[i.line-1],p=i.line===l.line?l.column:a.length+1,m=p-i.column||1;t+=`
 --> `+s+`
`+c+` |
`+o.line+" | "+a+`
`+c+" | "+Xe("",i.column-1," ")+Xe("",m,"^")}else t+=`
 at `+s}return t};ke.buildMessage=function(e,t){var n={literal:function(a){return'"'+i(a.text)+'"'},class:function(a){var p=a.parts.map(function(m){return Array.isArray(m)?o(m[0])+"-"+o(m[1]):o(m)});return"["+(a.inverted?"^":"")+p.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(a){return a.description}};function r(a){return a.charCodeAt(0).toString(16).toUpperCase()}function i(a){return a.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(p){return"\\x0"+r(p)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(p){return"\\x"+r(p)})}function o(a){return a.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(p){return"\\x0"+r(p)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(p){return"\\x"+r(p)})}function s(a){return n[a.type](a)}function l(a){var p=a.map(s),m,g;if(p.sort(),p.length>0){for(m=1,g=1;m<p.length;m++)p[m-1]!==p[m]&&(p[g]=p[m],g++);p.length=g}switch(p.length){case 1:return p[0];case 2:return p[0]+" or "+p[1];default:return p.slice(0,-1).join(", ")+", or "+p[p.length-1]}}function c(a){return a?'"'+i(a)+'"':"end of input"}return"Expected "+l(e)+" but "+c(t)+" found."};function Ur(e,t){t=t!==void 0?t:{};var n={},r=t.grammarSource,i={pgn:qt},o=qt,s="[",l='"',c="]",a=".",p="O-O-O",m="O-O",g="0-0-0",y="0-0",v="$",_="{",C="}",I=";",K="(",X=")",le="1-0",G="0-1",N="1/2-1/2",U="*",T=/^[a-zA-Z]/,w=/^[^"]/,S=/^[0-9]/,x=/^[.]/,j=/^[a-zA-Z1-8\-=]/,Ne=/^[+#]/,Ee=/^[!?]/,kt=/^[^}]/,Et=/^[^\r\n]/,At=/^[ \t\r\n]/,Kn=J("tag pair"),qn=F("[",!1),Pt=F('"',!1),Dn=F("]",!1),Rn=J("tag name"),Ye=re([["a","z"],["A","Z"]],!1,!1),Fn=J("tag value"),$t=re(['"'],!0,!1),Bn=J("move number"),Ke=re([["0","9"]],!1,!1),Un=F(".",!1),Mt=re(["."],!1,!1),Hn=J("standard algebraic notation"),Wn=F("O-O-O",!1),Gn=F("O-O",!1),jn=F("0-0-0",!1),zn=F("0-0",!1),Tt=re([["a","z"],["A","Z"],["1","8"],"-","="],!1,!1),Qn=re(["+","#"],!1,!1),Vn=J("suffix annotation"),It=re(["!","?"],!1,!1),Yn=J("NAG"),Zn=F("$",!1),Xn=J("brace comment"),Jn=F("{",!1),xt=re(["}"],!0,!1),er=F("}",!1),tr=J("rest of line comment"),nr=F(";",!1),Ot=re(["\r",`
`],!0,!1),rr=J("variation"),ir=F("(",!1),or=F(")",!1),sr=J("game termination marker"),lr=F("1-0",!1),ar=F("0-1",!1),cr=F("1/2-1/2",!1),ur=F("*",!1),fr=J("whitespace"),Lt=re([" ","	","\r",`
`],!1,!1),hr=function(u,h){return Fr(u,h)},dr=function(u){return Object.fromEntries(u)},pr=function(u,h){return[u,h]},gr=function(u,h){return{root:u,marker:h}},mr=function(u,h){return Rr(qr(u),...h.flat())},vr=function(u,h,d,E,A){return Dr(u,h,d,E,A)},br=function(u){return u},_r=function(u){return u.replace(/[\r\n]+/g," ")},wr=function(u){return u.trim()},yr=function(u){return u},Sr=function(u,h){return{result:u,comment:h}},f=t.peg$currPos|0,Ce=[{line:1,column:1}],ne=f,qe=t.peg$maxFailExpected||[],b=t.peg$silentFails|0,Ae;if(t.startRule){if(!(t.startRule in i))throw new Error(`Can't start parsing from rule "`+t.startRule+'".');o=i[t.startRule]}function F(u,h){return{type:"literal",text:u,ignoreCase:h}}function re(u,h,d){return{type:"class",parts:u,inverted:h,ignoreCase:d}}function Cr(){return{type:"end"}}function J(u){return{type:"other",description:u}}function Nt(u){var h=Ce[u],d;if(h)return h;if(u>=Ce.length)d=Ce.length-1;else for(d=u;!Ce[--d];);for(h=Ce[d],h={line:h.line,column:h.column};d<u;)e.charCodeAt(d)===10?(h.line++,h.column=1):h.column++,d++;return Ce[u]=h,h}function Kt(u,h,d){var E=Nt(u),A=Nt(h),M={source:r,start:{offset:u,line:E.line,column:E.column},end:{offset:h,line:A.line,column:A.column}};return M}function k(u){f<ne||(f>ne&&(ne=f,qe=[]),qe.push(u))}function kr(u,h,d){return new ke(ke.buildMessage(u,h),u,h,d)}function qt(){var u,h,d;return u=f,h=Er(),d=$r(),u=hr(h,d),u}function Er(){var u,h,d;for(u=f,h=[],d=Dt();d!==n;)h.push(d),d=Dt();return d=z(),u=dr(h),u}function Dt(){var u,h,d,E,A,M,ge;return b++,u=f,z(),e.charCodeAt(f)===91?(h=s,f++):(h=n,b===0&&k(qn)),h!==n?(z(),d=Ar(),d!==n?(z(),e.charCodeAt(f)===34?(E=l,f++):(E=n,b===0&&k(Pt)),E!==n?(A=Pr(),e.charCodeAt(f)===34?(M=l,f++):(M=n,b===0&&k(Pt)),M!==n?(z(),e.charCodeAt(f)===93?(ge=c,f++):(ge=n,b===0&&k(Dn)),ge!==n?u=pr(d,A):(f=u,u=n)):(f=u,u=n)):(f=u,u=n)):(f=u,u=n)):(f=u,u=n),b--,u===n&&b===0&&k(Kn),u}function Ar(){var u,h,d;if(b++,u=f,h=[],d=e.charAt(f),T.test(d)?f++:(d=n,b===0&&k(Ye)),d!==n)for(;d!==n;)h.push(d),d=e.charAt(f),T.test(d)?f++:(d=n,b===0&&k(Ye));else h=n;return h!==n?u=e.substring(u,f):u=h,b--,u===n&&(h=n,b===0&&k(Rn)),u}function Pr(){var u,h,d;for(b++,u=f,h=[],d=e.charAt(f),w.test(d)?f++:(d=n,b===0&&k($t));d!==n;)h.push(d),d=e.charAt(f),w.test(d)?f++:(d=n,b===0&&k($t));return u=e.substring(u,f),b--,h=n,b===0&&k(Fn),u}function $r(){var u,h,d;return u=f,h=Rt(),z(),d=Lr(),d===n&&(d=null),z(),u=gr(h,d),u}function Rt(){var u,h,d,E;for(u=f,h=Ze(),h===n&&(h=null),d=[],E=Ft();E!==n;)d.push(E),E=Ft();return u=mr(h,d),u}function Ft(){var u,h,d,E,A,M,ge,De;if(u=f,z(),Mr(),z(),h=Tr(),h!==n){for(d=Ir(),d===n&&(d=null),E=[],A=Bt();A!==n;)E.push(A),A=Bt();for(A=z(),M=Ze(),M===n&&(M=null),ge=[],De=Ut();De!==n;)ge.push(De),De=Ut();u=vr(h,d,E,M,ge)}else f=u,u=n;return u}function Mr(){var u,h,d,E,A,M;for(b++,u=f,h=[],d=e.charAt(f),S.test(d)?f++:(d=n,b===0&&k(Ke));d!==n;)h.push(d),d=e.charAt(f),S.test(d)?f++:(d=n,b===0&&k(Ke));if(e.charCodeAt(f)===46?(d=a,f++):(d=n,b===0&&k(Un)),d!==n){for(E=z(),A=[],M=e.charAt(f),x.test(M)?f++:(M=n,b===0&&k(Mt));M!==n;)A.push(M),M=e.charAt(f),x.test(M)?f++:(M=n,b===0&&k(Mt));h=[h,d,E,A],u=h}else f=u,u=n;return b--,u===n&&(h=n,b===0&&k(Bn)),u}function Tr(){var u,h,d,E,A,M;if(b++,u=f,h=f,e.substr(f,5)===p?(d=p,f+=5):(d=n,b===0&&k(Wn)),d===n&&(e.substr(f,3)===m?(d=m,f+=3):(d=n,b===0&&k(Gn)),d===n&&(e.substr(f,5)===g?(d=g,f+=5):(d=n,b===0&&k(jn)),d===n&&(e.substr(f,3)===y?(d=y,f+=3):(d=n,b===0&&k(zn)),d===n))))if(d=f,E=e.charAt(f),T.test(E)?f++:(E=n,b===0&&k(Ye)),E!==n){if(A=[],M=e.charAt(f),j.test(M)?f++:(M=n,b===0&&k(Tt)),M!==n)for(;M!==n;)A.push(M),M=e.charAt(f),j.test(M)?f++:(M=n,b===0&&k(Tt));else A=n;A!==n?(E=[E,A],d=E):(f=d,d=n)}else f=d,d=n;return d!==n?(E=e.charAt(f),Ne.test(E)?f++:(E=n,b===0&&k(Qn)),E===n&&(E=null),d=[d,E],h=d):(f=h,h=n),h!==n?u=e.substring(u,f):u=h,b--,u===n&&(h=n,b===0&&k(Hn)),u}function Ir(){var u,h,d;for(b++,u=f,h=[],d=e.charAt(f),Ee.test(d)?f++:(d=n,b===0&&k(It));d!==n;)h.push(d),h.length>=2?d=n:(d=e.charAt(f),Ee.test(d)?f++:(d=n,b===0&&k(It)));return h.length<1?(f=u,u=n):u=h,b--,u===n&&(h=n,b===0&&k(Vn)),u}function Bt(){var u,h,d,E,A;if(b++,u=f,z(),e.charCodeAt(f)===36?(h=v,f++):(h=n,b===0&&k(Zn)),h!==n){if(d=f,E=[],A=e.charAt(f),S.test(A)?f++:(A=n,b===0&&k(Ke)),A!==n)for(;A!==n;)E.push(A),A=e.charAt(f),S.test(A)?f++:(A=n,b===0&&k(Ke));else E=n;E!==n?d=e.substring(d,f):d=E,d!==n?u=br(d):(f=u,u=n)}else f=u,u=n;return b--,u===n&&b===0&&k(Yn),u}function Ze(){var u;return u=xr(),u===n&&(u=Or()),u}function xr(){var u,h,d,E,A;if(b++,u=f,e.charCodeAt(f)===123?(h=_,f++):(h=n,b===0&&k(Jn)),h!==n){for(d=f,E=[],A=e.charAt(f),kt.test(A)?f++:(A=n,b===0&&k(xt));A!==n;)E.push(A),A=e.charAt(f),kt.test(A)?f++:(A=n,b===0&&k(xt));d=e.substring(d,f),e.charCodeAt(f)===125?(E=C,f++):(E=n,b===0&&k(er)),E!==n?u=_r(d):(f=u,u=n)}else f=u,u=n;return b--,u===n&&(h=n,b===0&&k(Xn)),u}function Or(){var u,h,d,E,A;if(b++,u=f,e.charCodeAt(f)===59?(h=I,f++):(h=n,b===0&&k(nr)),h!==n){for(d=f,E=[],A=e.charAt(f),Et.test(A)?f++:(A=n,b===0&&k(Ot));A!==n;)E.push(A),A=e.charAt(f),Et.test(A)?f++:(A=n,b===0&&k(Ot));d=e.substring(d,f),u=wr(d)}else f=u,u=n;return b--,u===n&&(h=n,b===0&&k(tr)),u}function Ut(){var u,h,d,E;return b++,u=f,z(),e.charCodeAt(f)===40?(h=K,f++):(h=n,b===0&&k(ir)),h!==n?(d=Rt(),d!==n?(z(),e.charCodeAt(f)===41?(E=X,f++):(E=n,b===0&&k(or)),E!==n?u=yr(d):(f=u,u=n)):(f=u,u=n)):(f=u,u=n),b--,u===n&&b===0&&k(rr),u}function Lr(){var u,h,d;return b++,u=f,e.substr(f,3)===le?(h=le,f+=3):(h=n,b===0&&k(lr)),h===n&&(e.substr(f,3)===G?(h=G,f+=3):(h=n,b===0&&k(ar)),h===n&&(e.substr(f,7)===N?(h=N,f+=7):(h=n,b===0&&k(cr)),h===n&&(e.charCodeAt(f)===42?(h=U,f++):(h=n,b===0&&k(ur))))),h!==n?(z(),d=Ze(),d===n&&(d=null),u=Sr(h,d)):(f=u,u=n),b--,u===n&&(h=n,b===0&&k(sr)),u}function z(){var u,h;for(b++,u=[],h=e.charAt(f),At.test(h)?f++:(h=n,b===0&&k(Lt));h!==n;)u.push(h),h=e.charAt(f),At.test(h)?f++:(h=n,b===0&&k(Lt));return b--,h=n,b===0&&k(fr),u}if(Ae=o(),t.peg$library)return{peg$result:Ae,peg$currPos:f,peg$FAILED:n,peg$maxFailExpected:qe,peg$maxFailPos:ne};if(Ae!==n&&f===e.length)return Ae;throw Ae!==n&&f<e.length&&k(Cr()),kr(qe,ne<e.length?e.charAt(ne):null,ne<e.length?Kt(ne,ne+1):Kt(ne,ne))}/**
 * @license
 * Copyright (c) 2025, Jeff Hlywa (jhlywa@gmail.com)
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice,
 *    this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 *    this list of conditions and the following disclaimer in the documentation
 *    and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */const Be=0xffffffffffffffffn;function Je(e,t){return(e<<t|e>>64n-t)&0xffffffffffffffffn}function Ht(e,t){return e*t&Be}function Hr(e){return function(){let t=BigInt(e&Be),n=BigInt(e>>64n&Be);const r=Ht(Je(Ht(t,5n),7n),9n);return n^=t,t=(Je(t,24n)^n^n<<16n)&Be,n=Je(n,37n),e=n<<64n|t,r}}const Ve=Hr(0xa187eb39cdcaed8f31c4b365b102e01en),Wr=Array.from({length:2},()=>Array.from({length:6},()=>Array.from({length:128},()=>Ve()))),Gr=Array.from({length:8},()=>Ve()),jr=Array.from({length:16},()=>Ve()),et=Ve(),W="w",Z="b",q="p",ct="n",Ue="b",Te="r",fe="q",D="k",tt="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";class Re{constructor(t,n){O(this,"color");O(this,"from");O(this,"to");O(this,"piece");O(this,"captured");O(this,"promotion");O(this,"flags");O(this,"san");O(this,"lan");O(this,"before");O(this,"after");const{color:r,piece:i,from:o,to:s,flags:l,captured:c,promotion:a}=n,p=B(o),m=B(s);this.color=r,this.piece=i,this.from=p,this.to=m,this.san=t._moveToSan(n,t._moves({legal:!0})),this.lan=p+m,this.before=t.fen(),t._makeMove(n),this.after=t.fen(),t._undoMove(),this.flags="";for(const g in $)$[g]&l&&(this.flags+=me[g]);c&&(this.captured=c),a&&(this.promotion=a,this.lan+=a)}isCapture(){return this.flags.indexOf(me.CAPTURE)>-1}isPromotion(){return this.flags.indexOf(me.PROMOTION)>-1}isEnPassant(){return this.flags.indexOf(me.EP_CAPTURE)>-1}isKingsideCastle(){return this.flags.indexOf(me.KSIDE_CASTLE)>-1}isQueensideCastle(){return this.flags.indexOf(me.QSIDE_CASTLE)>-1}isBigPawn(){return this.flags.indexOf(me.BIG_PAWN)>-1}}const H=-1,me={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q",NULL_MOVE:"-"},$={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64,NULL_MOVE:128},ut={Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:"*"},zr={WhiteTitle:null,BlackTitle:null,WhiteElo:null,BlackElo:null,WhiteUSCF:null,BlackUSCF:null,WhiteNA:null,BlackNA:null,WhiteType:null,BlackType:null,EventDate:null,EventSponsor:null,Section:null,Stage:null,Board:null,Opening:null,Variation:null,SubVariation:null,ECO:null,NIC:null,Time:null,UTCTime:null,UTCDate:null,TimeControl:null,SetUp:null,FEN:null,Termination:null,Annotator:null,Mode:null,PlyCount:null},Qr={...ut,...zr},P={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},nt={b:[16,32,17,15],w:[-16,-32,-17,-15]},Wt={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},Vr=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],Yr=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],Zr={p:1,n:2,b:4,r:8,q:16,k:32},Xr="pnbrqkPNBRQK",Gt=[ct,Ue,Te,fe],Jr=7,ei=6,ti=1,ni=0,Fe={[D]:$.KSIDE_CASTLE,[fe]:$.QSIDE_CASTLE},ae={w:[{square:P.a1,flag:$.QSIDE_CASTLE},{square:P.h1,flag:$.KSIDE_CASTLE}],b:[{square:P.a8,flag:$.QSIDE_CASTLE},{square:P.h8,flag:$.KSIDE_CASTLE}]},ri={b:ti,w:ei},rt="--";function _e(e){return e>>4}function xe(e){return e&15}function on(e){return"0123456789".indexOf(e)!==-1}function B(e){const t=xe(e),n=_e(e);return"abcdefgh".substring(t,t+1)+"87654321".substring(n,n+1)}function Pe(e){return e===W?Z:W}function ii(e){const t=e.split(/\s+/);if(t.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};const n=parseInt(t[5],10);if(isNaN(n)||n<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};const r=parseInt(t[4],10);if(isNaN(r)||r<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(t[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(t[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(t[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};const i=t[0].split("/");if(i.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let s=0;s<i.length;s++){let l=0,c=!1;for(let a=0;a<i[s].length;a++)if(on(i[s][a])){if(c)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};l+=parseInt(i[s][a],10),c=!0}else{if(!/^[prnbqkPRNBQK]$/.test(i[s][a]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};l+=1,c=!1}if(l!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(t[3][1]=="3"&&t[1]=="w"||t[3][1]=="6"&&t[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};const o=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(const{color:s,regex:l}of o){if(!l.test(t[0]))return{ok:!1,error:`Invalid FEN: missing ${s} king`};if((t[0].match(l)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${s} kings`}}return Array.from(i[0]+i[7]).some(s=>s.toUpperCase()==="P")?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}function oi(e,t){const n=e.from,r=e.to,i=e.piece;let o=0,s=0,l=0;for(let c=0,a=t.length;c<a;c++){const p=t[c].from,m=t[c].to,g=t[c].piece;i===g&&n!==p&&r===m&&(o++,_e(n)===_e(p)&&s++,xe(n)===xe(p)&&l++)}return o>0?s>0&&l>0?B(n):l>0?B(n).charAt(1):B(n).charAt(0):""}function ce(e,t,n,r,i,o=void 0,s=$.NORMAL){const l=_e(r);if(i===q&&(l===Jr||l===ni))for(let c=0;c<Gt.length;c++){const a=Gt[c];e.push({color:t,from:n,to:r,piece:i,captured:o,promotion:a,flags:s|$.PROMOTION})}else e.push({color:t,from:n,to:r,piece:i,captured:o,flags:s})}function jt(e){let t=e.charAt(0);return t>="a"&&t<="h"?e.match(/[a-h]\d.*[a-h]\d/)?void 0:q:(t=t.toLowerCase(),t==="o"?D:t)}function it(e){return e.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}class si{constructor(t=tt,{skipValidation:n=!1}={}){O(this,"_board",new Array(128));O(this,"_turn",W);O(this,"_header",{});O(this,"_kings",{w:H,b:H});O(this,"_epSquare",-1);O(this,"_halfMoves",0);O(this,"_moveNumber",0);O(this,"_history",[]);O(this,"_comments",{});O(this,"_castling",{w:0,b:0});O(this,"_hash",0n);O(this,"_positionCount",new Map);this.load(t,{skipValidation:n})}clear({preserveHeaders:t=!1}={}){this._board=new Array(128),this._kings={w:H,b:H},this._turn=W,this._castling={w:0,b:0},this._epSquare=H,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=t?this._header:{...Qr},this._hash=this._computeHash(),this._positionCount=new Map,this._header.SetUp=null,this._header.FEN=null}load(t,{skipValidation:n=!1,preserveHeaders:r=!1}={}){let i=t.split(/\s+/);if(i.length>=2&&i.length<6){const l=["-","-","0","1"];t=i.concat(l.slice(-(6-i.length))).join(" ")}if(i=t.split(/\s+/),!n){const{ok:l,error:c}=ii(t);if(!l)throw new Error(c)}const o=i[0];let s=0;this.clear({preserveHeaders:r});for(let l=0;l<o.length;l++){const c=o.charAt(l);if(c==="/")s+=8;else if(on(c))s+=parseInt(c,10);else{const a=c<"a"?W:Z;this._put({type:c.toLowerCase(),color:a},B(s)),s++}}this._turn=i[1],i[2].indexOf("K")>-1&&(this._castling.w|=$.KSIDE_CASTLE),i[2].indexOf("Q")>-1&&(this._castling.w|=$.QSIDE_CASTLE),i[2].indexOf("k")>-1&&(this._castling.b|=$.KSIDE_CASTLE),i[2].indexOf("q")>-1&&(this._castling.b|=$.QSIDE_CASTLE),this._epSquare=i[3]==="-"?H:P[i[3]],this._halfMoves=parseInt(i[4],10),this._moveNumber=parseInt(i[5],10),this._hash=this._computeHash(),this._updateSetup(t),this._incPositionCount()}fen({forceEnpassantSquare:t=!1}={}){var s,l;let n=0,r="";for(let c=P.a8;c<=P.h1;c++){if(this._board[c]){n>0&&(r+=n,n=0);const{color:a,type:p}=this._board[c];r+=a===W?p.toUpperCase():p.toLowerCase()}else n++;c+1&136&&(n>0&&(r+=n),c!==P.h1&&(r+="/"),n=0,c+=8)}let i="";this._castling[W]&$.KSIDE_CASTLE&&(i+="K"),this._castling[W]&$.QSIDE_CASTLE&&(i+="Q"),this._castling[Z]&$.KSIDE_CASTLE&&(i+="k"),this._castling[Z]&$.QSIDE_CASTLE&&(i+="q"),i=i||"-";let o="-";if(this._epSquare!==H)if(t)o=B(this._epSquare);else{const c=this._epSquare+(this._turn===W?16:-16),a=[c+1,c-1];for(const p of a){if(p&136)continue;const m=this._turn;if(((s=this._board[p])==null?void 0:s.color)===m&&((l=this._board[p])==null?void 0:l.type)===q){this._makeMove({color:m,from:p,to:this._epSquare,piece:q,captured:q,flags:$.EP_CAPTURE});const g=!this._isKingAttacked(m);if(this._undoMove(),g){o=B(this._epSquare);break}}}}return[r,this._turn,i,o,this._halfMoves,this._moveNumber].join(" ")}_pieceKey(t){if(!this._board[t])return 0n;const{color:n,type:r}=this._board[t],i={w:0,b:1}[n],o={p:0,n:1,b:2,r:3,q:4,k:5}[r];return Wr[i][o][t]}_epKey(){return this._epSquare===H?0n:Gr[this._epSquare&7]}_castlingKey(){const t=this._castling.w>>5|this._castling.b>>3;return jr[t]}_computeHash(){let t=0n;for(let n=P.a8;n<=P.h1;n++){if(n&136){n+=7;continue}this._board[n]&&(t^=this._pieceKey(n))}return t^=this._epKey(),t^=this._castlingKey(),this._turn==="b"&&(t^=et),t}_updateSetup(t){this._history.length>0||(t!==tt?(this._header.SetUp="1",this._header.FEN=t):(this._header.SetUp=null,this._header.FEN=null))}reset(){this.load(tt)}get(t){return this._board[P[t]]}findPiece(t){var r;const n=[];for(let i=P.a8;i<=P.h1;i++){if(i&136){i+=7;continue}!this._board[i]||((r=this._board[i])==null?void 0:r.color)!==t.color||this._board[i].color===t.color&&this._board[i].type===t.type&&n.push(B(i))}return n}put({type:t,color:n},r){return this._put({type:t,color:n},r)?(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0):!1}_set(t,n){this._hash^=this._pieceKey(t),this._board[t]=n,this._hash^=this._pieceKey(t)}_put({type:t,color:n},r){if(Xr.indexOf(t.toLowerCase())===-1||!(r in P))return!1;const i=P[r];if(t==D&&!(this._kings[n]==H||this._kings[n]==i))return!1;const o=this._board[i];return o&&o.type===D&&(this._kings[o.color]=H),this._set(i,{type:t,color:n}),t===D&&(this._kings[n]=i),!0}_clear(t){this._hash^=this._pieceKey(t),delete this._board[t]}remove(t){const n=this.get(t);return this._clear(P[t]),n&&n.type===D&&(this._kings[n.color]=H),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),n}_updateCastlingRights(){var r,i,o,s,l,c,a,p,m,g,y,v;this._hash^=this._castlingKey();const t=((r=this._board[P.e1])==null?void 0:r.type)===D&&((i=this._board[P.e1])==null?void 0:i.color)===W,n=((o=this._board[P.e8])==null?void 0:o.type)===D&&((s=this._board[P.e8])==null?void 0:s.color)===Z;(!t||((l=this._board[P.a1])==null?void 0:l.type)!==Te||((c=this._board[P.a1])==null?void 0:c.color)!==W)&&(this._castling.w&=-65),(!t||((a=this._board[P.h1])==null?void 0:a.type)!==Te||((p=this._board[P.h1])==null?void 0:p.color)!==W)&&(this._castling.w&=-33),(!n||((m=this._board[P.a8])==null?void 0:m.type)!==Te||((g=this._board[P.a8])==null?void 0:g.color)!==Z)&&(this._castling.b&=-65),(!n||((y=this._board[P.h8])==null?void 0:y.type)!==Te||((v=this._board[P.h8])==null?void 0:v.color)!==Z)&&(this._castling.b&=-33),this._hash^=this._castlingKey()}_updateEnPassantSquare(){var o,s;if(this._epSquare===H)return;const t=this._epSquare+(this._turn===W?-16:16),n=this._epSquare+(this._turn===W?16:-16),r=[n+1,n-1];if(this._board[t]!==null||this._board[this._epSquare]!==null||((o=this._board[n])==null?void 0:o.color)!==Pe(this._turn)||((s=this._board[n])==null?void 0:s.type)!==q){this._hash^=this._epKey(),this._epSquare=H;return}const i=l=>{var c,a;return!(l&136)&&((c=this._board[l])==null?void 0:c.color)===this._turn&&((a=this._board[l])==null?void 0:a.type)===q};r.some(i)||(this._hash^=this._epKey(),this._epSquare=H)}_attacked(t,n,r){const i=[];for(let o=P.a8;o<=P.h1;o++){if(o&136){o+=7;continue}if(this._board[o]===void 0||this._board[o].color!==t)continue;const s=this._board[o],l=o-n;if(l===0)continue;const c=l+119;if(Vr[c]&Zr[s.type]){if(s.type===q){if(l>0&&s.color===W||l<=0&&s.color===Z)if(r)i.push(B(o));else return!0;continue}if(s.type==="n"||s.type==="k")if(r){i.push(B(o));continue}else return!0;const a=Yr[c];let p=o+a,m=!1;for(;p!==n;){if(this._board[p]!=null){m=!0;break}p+=a}if(!m)if(r){i.push(B(o));continue}else return!0}}return r?i:!1}attackers(t,n){return n?this._attacked(n,P[t],!0):this._attacked(this._turn,P[t],!0)}_isKingAttacked(t){const n=this._kings[t];return n===-1?!1:this._attacked(Pe(t),n)}hash(){return this._hash.toString(16)}isAttacked(t,n){return this._attacked(n,P[t])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){const t={b:0,n:0,r:0,q:0,k:0,p:0},n=[];let r=0,i=0;for(let o=P.a8;o<=P.h1;o++){if(i=(i+1)%2,o&136){o+=7;continue}const s=this._board[o];s&&(t[s.type]=s.type in t?t[s.type]+1:1,s.type===Ue&&n.push(i),r++)}if(r===2)return!0;if(r===3&&(t[Ue]===1||t[ct]===1))return!0;if(r===t[Ue]+2){let o=0;const s=n.length;for(let l=0;l<s;l++)o+=n[l];if(o===0||o===s)return!0}return!1}isThreefoldRepetition(){return this._getPositionCount(this._hash)>=3}isDrawByFiftyMoves(){return this._halfMoves>=100}isDraw(){return this.isDrawByFiftyMoves()||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isDraw()}moves({verbose:t=!1,square:n=void 0,piece:r=void 0}={}){const i=this._moves({square:n,piece:r});return t?i.map(o=>new Re(this,o)):i.map(o=>this._moveToSan(o,i))}_moves({legal:t=!0,piece:n=void 0,square:r=void 0}={}){var y;const i=r?r.toLowerCase():void 0,o=n==null?void 0:n.toLowerCase(),s=[],l=this._turn,c=Pe(l);let a=P.a8,p=P.h1,m=!1;if(i)if(i in P)a=p=P[i],m=!0;else return[];for(let v=a;v<=p;v++){if(v&136){v+=7;continue}if(!this._board[v]||this._board[v].color===c)continue;const{type:_}=this._board[v];let C;if(_===q){if(o&&o!==_)continue;C=v+nt[l][0],this._board[C]||(ce(s,l,v,C,q),C=v+nt[l][1],ri[l]===_e(v)&&!this._board[C]&&ce(s,l,v,C,q,void 0,$.BIG_PAWN));for(let I=2;I<4;I++)C=v+nt[l][I],!(C&136)&&(((y=this._board[C])==null?void 0:y.color)===c?ce(s,l,v,C,q,this._board[C].type,$.CAPTURE):C===this._epSquare&&ce(s,l,v,C,q,q,$.EP_CAPTURE))}else{if(o&&o!==_)continue;for(let I=0,K=Wt[_].length;I<K;I++){const X=Wt[_][I];for(C=v;C+=X,!(C&136);){if(!this._board[C])ce(s,l,v,C,_);else{if(this._board[C].color===l)break;ce(s,l,v,C,_,this._board[C].type,$.CAPTURE);break}if(_===ct||_===D)break}}}}if((o===void 0||o===D)&&(!m||p===this._kings[l])){if(this._castling[l]&$.KSIDE_CASTLE){const v=this._kings[l],_=v+2;!this._board[v+1]&&!this._board[_]&&!this._attacked(c,this._kings[l])&&!this._attacked(c,v+1)&&!this._attacked(c,_)&&ce(s,l,this._kings[l],_,D,void 0,$.KSIDE_CASTLE)}if(this._castling[l]&$.QSIDE_CASTLE){const v=this._kings[l],_=v-2;!this._board[v-1]&&!this._board[v-2]&&!this._board[v-3]&&!this._attacked(c,this._kings[l])&&!this._attacked(c,v-1)&&!this._attacked(c,_)&&ce(s,l,this._kings[l],_,D,void 0,$.QSIDE_CASTLE)}}if(!t||this._kings[l]===-1)return s;const g=[];for(let v=0,_=s.length;v<_;v++)this._makeMove(s[v]),this._isKingAttacked(l)||g.push(s[v]),this._undoMove();return g}move(t,{strict:n=!1}={}){let r=null;if(typeof t=="string")r=this._moveFromSan(t,n);else if(t===null)r=this._moveFromSan(rt,n);else if(typeof t=="object"){const o=this._moves();for(let s=0,l=o.length;s<l;s++)if(t.from===B(o[s].from)&&t.to===B(o[s].to)&&(!("promotion"in o[s])||t.promotion===o[s].promotion)){r=o[s];break}}if(!r)throw typeof t=="string"?new Error(`Invalid move: ${t}`):new Error(`Invalid move: ${JSON.stringify(t)}`);if(this.isCheck()&&r.flags&$.NULL_MOVE)throw new Error("Null move not allowed when in check");const i=new Re(this,r);return this._makeMove(r),this._incPositionCount(),i}_push(t){this._history.push({move:t,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_movePiece(t,n){this._hash^=this._pieceKey(t),this._board[n]=this._board[t],delete this._board[t],this._hash^=this._pieceKey(n)}_makeMove(t){var i,o,s,l;const n=this._turn,r=Pe(n);if(this._push(t),t.flags&$.NULL_MOVE){n===Z&&this._moveNumber++,this._halfMoves++,this._turn=r,this._epSquare=H;return}if(this._hash^=this._epKey(),this._hash^=this._castlingKey(),t.captured&&(this._hash^=this._pieceKey(t.to)),this._movePiece(t.from,t.to),t.flags&$.EP_CAPTURE&&(this._turn===Z?this._clear(t.to-16):this._clear(t.to+16)),t.promotion&&(this._clear(t.to),this._set(t.to,{type:t.promotion,color:n})),this._board[t.to].type===D){if(this._kings[n]=t.to,t.flags&$.KSIDE_CASTLE){const c=t.to-1,a=t.to+1;this._movePiece(a,c)}else if(t.flags&$.QSIDE_CASTLE){const c=t.to+1,a=t.to-2;this._movePiece(a,c)}this._castling[n]=0}if(this._castling[n]){for(let c=0,a=ae[n].length;c<a;c++)if(t.from===ae[n][c].square&&this._castling[n]&ae[n][c].flag){this._castling[n]^=ae[n][c].flag;break}}if(this._castling[r]){for(let c=0,a=ae[r].length;c<a;c++)if(t.to===ae[r][c].square&&this._castling[r]&ae[r][c].flag){this._castling[r]^=ae[r][c].flag;break}}if(this._hash^=this._castlingKey(),t.flags&$.BIG_PAWN){let c;n===Z?c=t.to-16:c=t.to+16,!(t.to-1&136)&&((i=this._board[t.to-1])==null?void 0:i.type)===q&&((o=this._board[t.to-1])==null?void 0:o.color)===r||!(t.to+1&136)&&((s=this._board[t.to+1])==null?void 0:s.type)===q&&((l=this._board[t.to+1])==null?void 0:l.color)===r?(this._epSquare=c,this._hash^=this._epKey()):this._epSquare=H}else this._epSquare=H;t.piece===q?this._halfMoves=0:t.flags&($.CAPTURE|$.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,n===Z&&this._moveNumber++,this._turn=r,this._hash^=et}undo(){const t=this._hash,n=this._undoMove();if(n){const r=new Re(this,n);return this._decPositionCount(t),r}return null}_undoMove(){const t=this._history.pop();if(t===void 0)return null;this._hash^=this._epKey(),this._hash^=this._castlingKey();const n=t.move;this._kings=t.kings,this._turn=t.turn,this._castling=t.castling,this._epSquare=t.epSquare,this._halfMoves=t.halfMoves,this._moveNumber=t.moveNumber,this._hash^=this._epKey(),this._hash^=this._castlingKey(),this._hash^=et;const r=this._turn,i=Pe(r);if(n.flags&$.NULL_MOVE)return n;if(this._movePiece(n.to,n.from),n.piece&&(this._clear(n.from),this._set(n.from,{type:n.piece,color:r})),n.captured)if(n.flags&$.EP_CAPTURE){let o;r===Z?o=n.to-16:o=n.to+16,this._set(o,{type:q,color:i})}else this._set(n.to,{type:n.captured,color:i});if(n.flags&($.KSIDE_CASTLE|$.QSIDE_CASTLE)){let o,s;n.flags&$.KSIDE_CASTLE?(o=n.to+1,s=n.to-1):(o=n.to-2,s=n.to+1),this._movePiece(s,o)}return n}pgn({newline:t=`
`,maxWidth:n=0}={}){const r=[];let i=!1;for(const g in this._header)this._header[g]&&r.push(`[${g} "${this._header[g]}"]`+t),i=!0;i&&this._history.length&&r.push(t);const o=g=>{const y=this._comments[this.fen()];if(typeof y<"u"){const v=g.length>0?" ":"";g=`${g}${v}{${y}}`}return g},s=[];for(;this._history.length>0;)s.push(this._undoMove());const l=[];let c="";for(s.length===0&&l.push(o(""));s.length>0;){c=o(c);const g=s.pop();if(!g)break;if(!this._history.length&&g.color==="b"){const y=`${this._moveNumber}. ...`;c=c?`${c} ${y}`:y}else g.color==="w"&&(c.length&&l.push(c),c=this._moveNumber+".");c=c+" "+this._moveToSan(g,this._moves({legal:!0})),this._makeMove(g)}if(c.length&&l.push(o(c)),l.push(this._header.Result||"*"),n===0)return r.join("")+l.join(" ");const a=function(){return r.length>0&&r[r.length-1]===" "?(r.pop(),!0):!1},p=function(g,y){for(const v of y.split(" "))if(v){if(g+v.length>n){for(;a();)g--;r.push(t),g=0}r.push(v),g+=v.length,r.push(" "),g++}return a()&&g--,g};let m=0;for(let g=0;g<l.length;g++){if(m+l[g].length>n&&l[g].includes("{")){m=p(m,l[g]);continue}m+l[g].length>n&&g!==0?(r[r.length-1]===" "&&r.pop(),r.push(t),m=0):g!==0&&(r.push(" "),m++),r.push(l[g]),m+=l[g].length}return r.join("")}header(...t){for(let n=0;n<t.length;n+=2)typeof t[n]=="string"&&typeof t[n+1]=="string"&&(this._header[t[n]]=t[n+1]);return this._header}setHeader(t,n){return this._header[t]=n??ut[t]??null,this.getHeaders()}removeHeader(t){return t in this._header?(this._header[t]=ut[t]||null,!0):!1}getHeaders(){const t={};for(const[n,r]of Object.entries(this._header))r!==null&&(t[n]=r);return t}loadPgn(t,{strict:n=!1,newlineChar:r=`\r?
`}={}){r!==`\r?
`&&(t=t.replace(new RegExp(r,"g"),`
`));const i=Ur(t);this.reset();const o=i.headers;let s="";for(const a in o)a.toLowerCase()==="fen"&&(s=o[a]),this.header(a,o[a]);if(!n)s&&this.load(s,{preserveHeaders:!0});else if(o.SetUp==="1"){if(!("FEN"in o))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(o.FEN,{preserveHeaders:!0})}let l=i.root;for(;l;){if(l.move){const a=this._moveFromSan(l.move,n);if(a==null)throw new Error(`Invalid move in PGN: ${l.move}`);this._makeMove(a),this._incPositionCount()}l.comment!==void 0&&(this._comments[this.fen()]=l.comment),l=l.variations[0]}const c=i.result;c&&Object.keys(this._header).length&&this._header.Result!==c&&this.setHeader("Result",c)}_moveToSan(t,n){let r="";if(t.flags&$.KSIDE_CASTLE)r="O-O";else if(t.flags&$.QSIDE_CASTLE)r="O-O-O";else{if(t.flags&$.NULL_MOVE)return rt;if(t.piece!==q){const i=oi(t,n);r+=t.piece.toUpperCase()+i}t.flags&($.CAPTURE|$.EP_CAPTURE)&&(t.piece===q&&(r+=B(t.from)[0]),r+="x"),r+=B(t.to),t.promotion&&(r+="="+t.promotion.toUpperCase())}return this._makeMove(t),this.isCheck()&&(this.isCheckmate()?r+="#":r+="+"),this._undoMove(),r}_moveFromSan(t,n=!1){let r=it(t);if(n||(r==="0-0"?r="O-O":r==="0-0-0"&&(r="O-O-O")),r==rt)return{color:this._turn,from:0,to:0,piece:"k",flags:$.NULL_MOVE};let i=jt(r),o=this._moves({legal:!0,piece:i});for(let g=0,y=o.length;g<y;g++)if(r===it(this._moveToSan(o[g],o)))return o[g];if(n)return null;let s,l,c,a,p,m=!1;if(l=r.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),l?(s=l[1],c=l[2],a=l[3],p=l[4],c.length==1&&(m=!0)):(l=r.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),l&&(s=l[1],c=l[2],a=l[3],p=l[4],c.length==1&&(m=!0))),i=jt(r),o=this._moves({legal:!0,piece:s||i}),!a)return null;for(let g=0,y=o.length;g<y;g++)if(c){if((!s||s.toLowerCase()==o[g].piece)&&P[c]==o[g].from&&P[a]==o[g].to&&(!p||p.toLowerCase()==o[g].promotion))return o[g];if(m){const v=B(o[g].from);if((!s||s.toLowerCase()==o[g].piece)&&P[a]==o[g].to&&(c==v[0]||c==v[1])&&(!p||p.toLowerCase()==o[g].promotion))return o[g]}}else if(r===it(this._moveToSan(o[g],o)).replace("x",""))return o[g];return null}ascii(){let t=`   +------------------------+
`;for(let n=P.a8;n<=P.h1;n++){if(xe(n)===0&&(t+=" "+"87654321"[_e(n)]+" |"),this._board[n]){const r=this._board[n].type,o=this._board[n].color===W?r.toUpperCase():r.toLowerCase();t+=" "+o+" "}else t+=" . ";n+1&136&&(t+=`|
`,n+=8)}return t+=`   +------------------------+
`,t+="     a  b  c  d  e  f  g  h",t}perft(t){const n=this._moves({legal:!1});let r=0;const i=this._turn;for(let o=0,s=n.length;o<s;o++)this._makeMove(n[o]),this._isKingAttacked(i)||(t-1>0?r+=this.perft(t-1):r++),this._undoMove();return r}setTurn(t){return this._turn==t?!1:(this.move("--"),!0)}turn(){return this._turn}board(){const t=[];let n=[];for(let r=P.a8;r<=P.h1;r++)this._board[r]==null?n.push(null):n.push({square:B(r),type:this._board[r].type,color:this._board[r].color}),r+1&136&&(t.push(n),n=[],r+=8);return t}squareColor(t){if(t in P){const n=P[t];return(_e(n)+xe(n))%2===0?"light":"dark"}return null}history({verbose:t=!1}={}){const n=[],r=[];for(;this._history.length>0;)n.push(this._undoMove());for(;;){const i=n.pop();if(!i)break;t?r.push(new Re(this,i)):r.push(this._moveToSan(i,this._moves())),this._makeMove(i)}return r}_getPositionCount(t){return this._positionCount.get(t)??0}_incPositionCount(){this._positionCount.set(this._hash,(this._positionCount.get(this._hash)??0)+1)}_decPositionCount(t){const n=this._positionCount.get(t)??0;n===1?this._positionCount.delete(t):this._positionCount.set(t,n-1)}_pruneComments(){const t=[],n={},r=i=>{i in this._comments&&(n[i]=this._comments[i])};for(;this._history.length>0;)t.push(this._undoMove());for(r(this.fen());;){const i=t.pop();if(!i)break;this._makeMove(i),r(this.fen())}this._comments=n}getComment(){return this._comments[this.fen()]}setComment(t){this._comments[this.fen()]=t.replace("{","[").replace("}","]")}deleteComment(){return this.removeComment()}removeComment(){const t=this._comments[this.fen()];return delete this._comments[this.fen()],t}getComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>({fen:t,comment:this._comments[t]}))}deleteComments(){return this.removeComments()}removeComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>{const n=this._comments[t];return delete this._comments[t],{fen:t,comment:n}})}setCastlingRights(t,n){for(const i of[D,fe])n[i]!==void 0&&(n[i]?this._castling[t]|=Fe[i]:this._castling[t]&=~Fe[i]);this._updateCastlingRights();const r=this.getCastlingRights(t);return(n[D]===void 0||n[D]===r[D])&&(n[fe]===void 0||n[fe]===r[fe])}getCastlingRights(t){return{[D]:(this._castling[t]&Fe[D])!==0,[fe]:(this._castling[t]&Fe[fe])!==0}}moveNumber(){return this._moveNumber}}class li{constructor(){this.chess=new si}makeMove(t){try{return this.chess.move(t)}catch(n){return console.warn("Error making move:",t,n.message),null}}getFen(){return this.chess.fen()}getLegalMoves(t){return t?this.chess.moves({square:t,verbose:!0}):(console.warn("getLegalMoves: square parameter is required."),this.chess.moves({verbose:!0}))}getAllLegalMoves(){return this.chess.moves({verbose:!0})}undoMove(){return this.chess.undo()}resetGame(){this.chess.reset()}loadFen(t){try{return this.chess.load(t),!0}catch(n){return console.error("Failed to load FEN:",t,n.message),!1}}getGameStatus(){return{isCheckmate:this.chess.isCheckmate(),isStalemate:this.chess.isStalemate(),isDraw:this.chess.isDraw(),isGameOver:this.chess.isGameOver(),isCheck:this.chess.isCheck(),turn:this.chess.turn()}}getTurn(){return this.chess.turn()}getPiece(t){return this.chess.get(t)}}const ai=["white","black"],He=["a","b","c","d","e","f","g","h"],We=["1","2","3","4","5","6","7","8"],ci=[...We].reverse(),gt=Array.prototype.concat(...He.map(e=>We.map(t=>e+t))),ee=e=>gt[8*e[0]+e[1]],L=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],sn=gt.map(L);function ui(e){let t;const n=()=>(t===void 0&&(t=e()),t);return n.clear=()=>{t=void 0},n}const fi=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const t=performance.now()-e;return e=void 0,t}}},mt=e=>e==="white"?"black":"white",Oe=(e,t)=>{const n=e[0]-t[0],r=e[1]-t[1];return n*n+r*r},ft=(e,t)=>e.role===t.role&&e.color===t.color,Le=e=>(t,n)=>[(n?t[0]:7-t[0])*e.width/8,(n?7-t[1]:t[1])*e.height/8],ie=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},ln=(e,t,n=1)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px) scale(${n})`},vt=(e,t)=>{e.style.visibility=t?"visible":"hidden"},ye=e=>{var t;if(e.clientX||e.clientX===0)return[e.clientX,e.clientY];if(!((t=e.targetTouches)===null||t===void 0)&&t[0])return[e.targetTouches[0].clientX,e.targetTouches[0].clientY]},an=e=>e.button===2,se=(e,t)=>{const n=document.createElement(e);return t&&(n.className=t),n};function cn(e,t,n){const r=L(e);return t||(r[0]=7-r[0],r[1]=7-r[1]),[n.left+n.width*r[0]/8+n.width/16,n.top+n.height*(7-r[1])/8+n.height/16]}const we=(e,t)=>Math.abs(e-t),hi=e=>(t,n,r,i)=>we(t,r)<2&&(e==="white"?i===n+1||n<=1&&i===n+2&&t===r:i===n-1||n>=6&&i===n-2&&t===r),un=(e,t,n,r)=>{const i=we(e,n),o=we(t,r);return i===1&&o===2||i===2&&o===1},fn=(e,t,n,r)=>we(e,n)===we(t,r),hn=(e,t,n,r)=>e===n||t===r,dn=(e,t,n,r)=>fn(e,t,n,r)||hn(e,t,n,r),di=(e,t,n)=>(r,i,o,s)=>we(r,o)<2&&we(i,s)<2||n&&i===s&&i===(e==="white"?0:7)&&(r===4&&(o===2&&t.includes(0)||o===6&&t.includes(7))||t.includes(o));function pi(e,t){const n=t==="white"?"1":"8",r=[];for(const[i,o]of e)i[1]===n&&o.color===t&&o.role==="rook"&&r.push(L(i)[0]);return r}function pn(e,t,n){const r=e.get(t);if(!r)return[];const i=L(t),o=r.role,s=o==="pawn"?hi(r.color):o==="knight"?un:o==="bishop"?fn:o==="rook"?hn:o==="queen"?dn:di(r.color,pi(e,r.color),n);return sn.filter(l=>(i[0]!==l[0]||i[1]!==l[1])&&s(i[0],i[1],l[0],l[1])).map(ee)}function V(e,...t){e&&setTimeout(()=>e(...t),1)}function gi(e){e.orientation=mt(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}function mi(e,t){for(const[n,r]of t)r?e.pieces.set(n,r):e.pieces.delete(n)}function vi(e,t){if(e.check=void 0,t===!0&&(t=e.turnColor),t)for(const[n,r]of e.pieces)r.role==="king"&&r.color===t&&(e.check=n)}function bi(e,t,n,r){pe(e),e.premovable.current=[t,n],V(e.premovable.events.set,t,n,r)}function de(e){e.premovable.current&&(e.premovable.current=void 0,V(e.premovable.events.unset))}function _i(e,t,n){de(e),e.predroppable.current={role:t,key:n},V(e.predroppable.events.set,t,n)}function pe(e){const t=e.predroppable;t.current&&(t.current=void 0,V(t.events.unset))}function wi(e,t,n){if(!e.autoCastle)return!1;const r=e.pieces.get(t);if(!r||r.role!=="king")return!1;const i=L(t),o=L(n);if(i[1]!==0&&i[1]!==7||i[1]!==o[1])return!1;i[0]===4&&!e.pieces.has(n)&&(o[0]===6?n=ee([7,o[1]]):o[0]===2&&(n=ee([0,o[1]])));const s=e.pieces.get(n);return!s||s.color!==r.color||s.role!=="rook"?!1:(e.pieces.delete(t),e.pieces.delete(n),i[0]<o[0]?(e.pieces.set(ee([6,o[1]]),r),e.pieces.set(ee([5,o[1]]),s)):(e.pieces.set(ee([2,o[1]]),r),e.pieces.set(ee([3,o[1]]),s)),!0)}function gn(e,t,n){const r=e.pieces.get(t),i=e.pieces.get(n);if(t===n||!r)return!1;const o=i&&i.color!==r.color?i:void 0;return n===e.selected&&te(e),V(e.events.move,t,n,o),wi(e,t,n)||(e.pieces.set(n,r),e.pieces.delete(t)),e.lastMove=[t,n],e.check=void 0,V(e.events.change),o||!0}function bt(e,t,n,r){if(e.pieces.has(n))if(r)e.pieces.delete(n);else return!1;return V(e.events.dropNewPiece,t,n),e.pieces.set(n,t),e.lastMove=[n],e.check=void 0,V(e.events.change),e.movable.dests=void 0,e.turnColor=mt(e.turnColor),!0}function mn(e,t,n){const r=gn(e,t,n);return r&&(e.movable.dests=void 0,e.turnColor=mt(e.turnColor),e.animation.current=void 0),r}function vn(e,t,n){if(_t(e,t,n)){const r=mn(e,t,n);if(r){const i=e.hold.stop();te(e);const o={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:i};return r!==!0&&(o.captured=r),V(e.movable.events.after,t,n,o),!0}}else if(Si(e,t,n))return bi(e,t,n,{ctrlKey:e.stats.ctrlKey}),te(e),!0;return te(e),!1}function bn(e,t,n,r){const i=e.pieces.get(t);i&&(yi(e,t,n)||r)?(e.pieces.delete(t),bt(e,i,n,r),V(e.movable.events.afterNewPiece,i.role,n,{premove:!1,predrop:!1})):i&&Ci(e,t,n)?_i(e,i.role,n):(de(e),pe(e)),e.pieces.delete(t),te(e)}function ht(e,t,n){if(V(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled){te(e),e.hold.cancel();return}else if((e.selectable.enabled||n)&&e.selected!==t&&vn(e,e.selected,t)){e.stats.dragged=!1;return}}(e.selectable.enabled||e.draggable.enabled)&&(wn(e,t)||wt(e,t))&&(_n(e,t),e.hold.start())}function _n(e,t){e.selected=t,wt(e,t)?e.premovable.customDests||(e.premovable.dests=pn(e.pieces,t,e.premovable.castle)):e.premovable.dests=void 0}function te(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function wn(e,t){const n=e.pieces.get(t);return!!n&&(e.movable.color==="both"||e.movable.color===n.color&&e.turnColor===n.color)}const _t=(e,t,n)=>{var r,i;return t!==n&&wn(e,t)&&(e.movable.free||!!(!((i=(r=e.movable.dests)===null||r===void 0?void 0:r.get(t))===null||i===void 0)&&i.includes(n)))};function yi(e,t,n){const r=e.pieces.get(t);return!!r&&(t===n||!e.pieces.has(n))&&(e.movable.color==="both"||e.movable.color===r.color&&e.turnColor===r.color)}function wt(e,t){const n=e.pieces.get(t);return!!n&&e.premovable.enabled&&e.movable.color===n.color&&e.turnColor!==n.color}function Si(e,t,n){var r,i;const o=(i=(r=e.premovable.customDests)===null||r===void 0?void 0:r.get(t))!==null&&i!==void 0?i:pn(e.pieces,t,e.premovable.castle);return t!==n&&wt(e,t)&&o.includes(n)}function Ci(e,t,n){const r=e.pieces.get(t),i=e.pieces.get(n);return!!r&&(!i||i.color!==e.movable.color)&&e.predroppable.enabled&&(r.role!=="pawn"||n[1]!=="1"&&n[1]!=="8")&&e.movable.color===r.color&&e.turnColor!==r.color}function ki(e,t){const n=e.pieces.get(t);return!!n&&e.draggable.enabled&&(e.movable.color==="both"||e.movable.color===n.color&&(e.turnColor===n.color||e.premovable.enabled))}function Ei(e){const t=e.premovable.current;if(!t)return!1;const n=t[0],r=t[1];let i=!1;if(_t(e,n,r)){const o=mn(e,n,r);if(o){const s={premove:!0};o!==!0&&(s.captured=o),V(e.movable.events.after,n,r,s),i=!0}}return de(e),i}function Ai(e,t){const n=e.predroppable.current;let r=!1;if(!n)return!1;if(t(n)){const i={role:n.role,color:e.movable.color};bt(e,i,n.key)&&(V(e.movable.events.afterNewPiece,n.role,n.key,{premove:!1,predrop:!0}),r=!0)}return pe(e),r}function yt(e){de(e),pe(e),te(e)}function zt(e){e.movable.color=e.movable.dests=e.animation.current=void 0,yt(e)}function Se(e,t,n){let r=Math.floor(8*(e[0]-n.left)/n.width);t||(r=7-r);let i=7-Math.floor(8*(e[1]-n.top)/n.height);return t||(i=7-i),r>=0&&r<8&&i>=0&&i<8?ee([r,i]):void 0}function Pi(e,t,n,r){const i=L(e),o=sn.filter(a=>dn(i[0],i[1],a[0],a[1])||un(i[0],i[1],a[0],a[1])),l=o.map(a=>cn(ee(a),n,r)).map(a=>Oe(t,a)),[,c]=l.reduce((a,p,m)=>a[0]<p?a:[p,m],[l[0],0]);return ee(o[c])}const Y=e=>e.orientation==="white",yn="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",$i={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},Mi={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function Sn(e){e==="start"&&(e=yn);const t=new Map;let n=7,r=0;for(const i of e)switch(i){case" ":case"[":return t;case"/":if(--n,n<0)return t;r=0;break;case"~":{const o=t.get(ee([r-1,n]));o&&(o.promoted=!0);break}default:{const o=i.charCodeAt(0);if(o<57)r+=o-48;else{const s=i.toLowerCase();t.set(ee([r,n]),{role:$i[s],color:i===s?"black":"white"}),++r}}}return t}function Ti(e){return ci.map(t=>He.map(n=>{const r=e.get(n+t);if(r){let i=Mi[r.role];return r.color==="white"&&(i=i.toUpperCase()),r.promoted&&(i+="~"),i}else return"1"}).join("")).join("/").replace(/1{2,}/g,t=>t.length.toString())}function Cn(e,t){t.animation&&(St(e.animation,t.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function kn(e,t){var n,r,i;if(!((n=t.movable)===null||n===void 0)&&n.dests&&(e.movable.dests=void 0),!((r=t.drawable)===null||r===void 0)&&r.autoShapes&&(e.drawable.autoShapes=[]),St(e,t),t.fen&&(e.pieces=Sn(t.fen),e.drawable.shapes=((i=t.drawable)===null||i===void 0?void 0:i.shapes)||[]),"check"in t&&vi(e,t.check||!1),"lastMove"in t&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&_n(e,e.selected),Cn(e,t),!e.movable.rookCastle&&e.movable.dests){const o=e.movable.color==="white"?"1":"8",s="e"+o,l=e.movable.dests.get(s),c=e.pieces.get(s);if(!l||!c||c.role!=="king")return;e.movable.dests.set(s,l.filter(a=>!(a==="a"+o&&l.includes("c"+o))&&!(a==="h"+o&&l.includes("g"+o))))}}function St(e,t){for(const n in t)n==="__proto__"||n==="constructor"||!Object.prototype.hasOwnProperty.call(t,n)||(Object.prototype.hasOwnProperty.call(e,n)&&Qt(e[n])&&Qt(t[n])?St(e[n],t[n]):e[n]=t[n])}function Qt(e){if(typeof e!="object"||e===null)return!1;const t=Object.getPrototypeOf(e);return t===Object.prototype||t===null}const be=(e,t)=>t.animation.enabled?Oi(e,t):ue(e,t);function ue(e,t){const n=e(t);return t.dom.redraw(),n}const ot=(e,t)=>({key:e,pos:L(e),piece:t}),Ii=(e,t)=>t.sort((n,r)=>Oe(e.pos,n.pos)-Oe(e.pos,r.pos))[0];function xi(e,t){const n=new Map,r=[],i=new Map,o=[],s=[],l=new Map;let c,a,p;for(const[m,g]of e)l.set(m,ot(m,g));for(const m of gt)c=t.pieces.get(m),a=l.get(m),c?a?ft(c,a.piece)||(o.push(a),s.push(ot(m,c))):s.push(ot(m,c)):a&&o.push(a);for(const m of s)a=Ii(m,o.filter(g=>ft(m.piece,g.piece))),a&&(p=[a.pos[0]-m.pos[0],a.pos[1]-m.pos[1]],n.set(m.key,p.concat(p)),r.push(a.key));for(const m of o)r.includes(m.key)||i.set(m.key,m.piece);return{anims:n,fadings:i}}function En(e,t){const n=e.animation.current;if(n===void 0){e.dom.destroyed||e.dom.redrawNow();return}const r=1-(t-n.start)*n.frequency;if(r<=0)e.animation.current=void 0,e.dom.redrawNow();else{const i=Li(r);for(const o of n.plan.anims.values())o[2]=o[0]*i,o[3]=o[1]*i;e.dom.redrawNow(!0),requestAnimationFrame((o=performance.now())=>En(e,o))}}function Oi(e,t){const n=new Map(t.pieces),r=e(t),i=xi(n,t);if(i.anims.size||i.fadings.size){const o=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:i},o||En(t,performance.now())}else t.dom.redraw();return r}const Li=e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1,Ni=["green","red","blue","yellow"];function Ki(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?te(e):yt(e);const n=ye(t),r=Se(n,Y(e),e.dom.bounds());r&&(e.drawable.current={orig:r,pos:n,brush:Fi(t),snapToValidMove:e.drawable.defaultSnapToValidMove},An(e))}function An(e){requestAnimationFrame(()=>{const t=e.drawable.current;if(t){const n=Se(t.pos,Y(e),e.dom.bounds());n||(t.snapToValidMove=!1);const r=t.snapToValidMove?Pi(t.orig,t.pos,Y(e),e.dom.bounds()):n;r!==t.mouseSq&&(t.mouseSq=r,t.dest=r!==t.orig?r:void 0,e.dom.redrawNow()),An(e)}})}function qi(e,t){e.drawable.current&&(e.drawable.current.pos=ye(t))}function Di(e){const t=e.drawable.current;t&&(t.mouseSq&&Bi(e.drawable,t),Pn(e))}function Pn(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function Ri(e){e.drawable.shapes.length&&(e.drawable.shapes=[],e.dom.redraw(),$n(e.drawable))}function Fi(e){var t;const n=(e.shiftKey||e.ctrlKey)&&an(e),r=e.altKey||e.metaKey||((t=e.getModifierState)===null||t===void 0?void 0:t.call(e,"AltGraph"));return Ni[(n?1:0)+(r?2:0)]}function Bi(e,t){const n=i=>i.orig===t.orig&&i.dest===t.dest,r=e.shapes.find(n);r&&(e.shapes=e.shapes.filter(i=>!n(i))),(!r||r.brush!==t.brush)&&e.shapes.push({orig:t.orig,dest:t.dest,brush:t.brush}),$n(e)}function $n(e){e.onChange&&e.onChange(e.shapes)}function Ui(e,t){if(!(e.trustAllEvents||t.isTrusted)||t.buttons!==void 0&&t.buttons>1||t.touches&&t.touches.length>1)return;const n=e.dom.bounds(),r=ye(t),i=Se(r,Y(e),n);if(!i)return;const o=e.pieces.get(i),s=e.selected;if(!s&&e.drawable.enabled&&(e.drawable.eraseOnClick||!o||o.color!==e.turnColor)&&Ri(e),t.cancelable!==!1&&(!t.touches||e.blockTouchScroll||o||s||Hi(e,r)))t.preventDefault();else if(t.touches)return;const l=!!e.premovable.current,c=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&_t(e,e.selected,i)?be(m=>ht(m,i),e):ht(e,i);const a=e.selected===i,p=Tn(e,i);if(o&&p&&a&&ki(e,i)){e.draggable.current={orig:i,piece:o,origPos:r,pos:r,started:e.draggable.autoDistance&&e.stats.dragged,element:p,previouslySelected:s,originTarget:t.target,keyHasChanged:!1},p.cgDragging=!0,p.classList.add("dragging");const m=e.dom.elements.ghost;m&&(m.className=`ghost ${o.color} ${o.role}`,ie(m,Le(n)(L(i),Y(e))),vt(m,!0)),Ct(e)}else l&&de(e),c&&pe(e);e.dom.redraw()}function Hi(e,t){const n=Y(e),r=e.dom.bounds(),i=Math.pow(r.width/8,2);for(const o of e.pieces.keys()){const s=cn(o,n,r);if(Oe(s,t)<=i)return!0}return!1}function Wi(e,t,n,r){const i="a0";e.pieces.set(i,t),e.dom.redraw();const o=ye(n);e.draggable.current={orig:i,piece:t,origPos:o,pos:o,started:!0,element:()=>Tn(e,i),originTarget:n.target,newPiece:!0,force:!!r,keyHasChanged:!1},Ct(e)}function Ct(e){requestAnimationFrame(()=>{var t;const n=e.draggable.current;if(!n)return;!((t=e.animation.current)===null||t===void 0)&&t.plan.anims.has(n.orig)&&(e.animation.current=void 0);const r=e.pieces.get(n.orig);if(!r||!ft(r,n.piece))Ge(e);else if(!n.started&&Oe(n.pos,n.origPos)>=Math.pow(e.draggable.distance,2)&&(n.started=!0),n.started){if(typeof n.element=="function"){const o=n.element();if(!o)return;o.cgDragging=!0,o.classList.add("dragging"),n.element=o}const i=e.dom.bounds();ie(n.element,[n.pos[0]-i.left-i.width/16,n.pos[1]-i.top-i.height/16]),n.keyHasChanged||(n.keyHasChanged=n.orig!==Se(n.pos,Y(e),i))}Ct(e)})}function Gi(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=ye(t))}function ji(e,t){const n=e.draggable.current;if(!n)return;if(t.type==="touchend"&&t.cancelable!==!1&&t.preventDefault(),t.type==="touchend"&&n.originTarget!==t.target&&!n.newPiece){e.draggable.current=void 0;return}de(e),pe(e);const r=ye(t)||n.pos,i=Se(r,Y(e),e.dom.bounds());i&&n.started&&n.orig!==i?n.newPiece?bn(e,n.orig,i,n.force):(e.stats.ctrlKey=t.ctrlKey,vn(e,n.orig,i)&&(e.stats.dragged=!0)):n.newPiece?e.pieces.delete(n.orig):e.draggable.deleteOnDropOff&&!i&&(e.pieces.delete(n.orig),V(e.events.change)),(n.orig===n.previouslySelected||n.keyHasChanged)&&(n.orig===i||!i)?te(e):e.selectable.enabled||te(e),Mn(e),e.draggable.current=void 0,e.dom.redraw()}function Ge(e){const t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,te(e),Mn(e),e.dom.redraw())}function Mn(e){const t=e.dom.elements;t.ghost&&vt(t.ghost,!1)}function Tn(e,t){let n=e.dom.elements.board.firstChild;for(;n;){if(n.cgKey===t&&n.tagName==="PIECE")return n;n=n.nextSibling}}function zi(e,t){e.exploding={stage:1,keys:t},e.dom.redraw(),setTimeout(()=>{Vt(e,2),setTimeout(()=>Vt(e,void 0),120)},120)}function Vt(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}function Qi(e,t){function n(){gi(e),t()}return{set(r){r.orientation&&r.orientation!==e.orientation&&n(),Cn(e,r),(r.fen?be:ue)(i=>kn(i,r),e)},state:e,getFen:()=>Ti(e.pieces),toggleOrientation:n,setPieces(r){be(i=>mi(i,r),e)},selectSquare(r,i){r?be(o=>ht(o,r,i),e):e.selected&&(te(e),e.dom.redraw())},move(r,i){be(o=>gn(o,r,i),e)},newPiece(r,i){be(o=>bt(o,r,i),e)},playPremove(){if(e.premovable.current){if(be(Ei,e))return!0;e.dom.redraw()}return!1},playPredrop(r){if(e.predroppable.current){const i=Ai(e,r);return e.dom.redraw(),i}return!1},cancelPremove(){ue(de,e)},cancelPredrop(){ue(pe,e)},cancelMove(){ue(r=>{yt(r),Ge(r)},e)},stop(){ue(r=>{zt(r),Ge(r)},e)},explode(r){zi(e,r)},setAutoShapes(r){ue(i=>i.drawable.autoShapes=r,e)},setShapes(r){ue(i=>i.drawable.shapes=r,e)},getKeyAtDomPos(r){return Se(r,Y(e),e.dom.bounds())},redrawAll:t,dragNewPiece(r,i,o){Wi(e,r,i,o)},destroy(){zt(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function Vi(){return{pieces:Sn(yn),orientation:"white",turnColor:"white",coordinates:!0,coordinatesOnSquares:!1,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,pieceKey:!1,trustAllEvents:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15},purple:{key:"purple",color:"#68217a",opacity:.65,lineWidth:10},pink:{key:"pink",color:"#ee2080",opacity:.5,lineWidth:10},white:{key:"white",color:"white",opacity:1,lineWidth:10}},prevSvgHash:""},hold:fi()}}const Yt={hilitePrimary:{key:"hilitePrimary",color:"#3291ff",opacity:1,lineWidth:1},hiliteWhite:{key:"hiliteWhite",color:"#ffffff",opacity:1,lineWidth:1}};function Yi(){const e=R("defs"),t=Q(R("filter"),{id:"cg-filter-blur"});return t.appendChild(Q(R("feGaussianBlur"),{stdDeviation:"0.019"})),e.appendChild(t),e}function Zi(e,t,n){var r;const i=e.drawable,o=i.current,s=o&&o.mouseSq?o:void 0,l=new Map,c=e.dom.bounds(),a=i.autoShapes.filter(y=>!y.piece);for(const y of i.shapes.concat(a).concat(s?[s]:[])){if(!y.dest)continue;const v=(r=l.get(y.dest))!==null&&r!==void 0?r:new Set,_=Qe(ze(L(y.orig),e.orientation),c),C=Qe(ze(L(y.dest),e.orientation),c);v.add(pt(_,C)),l.set(y.dest,v)}const p=i.shapes.concat(a).map(y=>({shape:y,current:!1,hash:Zt(y,dt(y.dest,l),!1,c)}));s&&p.push({shape:s,current:!0,hash:Zt(s,dt(s.dest,l),!0,c)});const m=p.map(y=>y.hash).join(";");if(m===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=m;const g=t.querySelector("defs");Xi(i,p,g),Ji(p,t.querySelector("g"),n.querySelector("g"),y=>no(e,y,i.brushes,l,c))}function Xi(e,t,n){var r;const i=new Map;let o;for(const c of t.filter(a=>a.shape.dest&&a.shape.brush))o=In(e.brushes[c.shape.brush],c.shape.modifiers),!((r=c.shape.modifiers)===null||r===void 0)&&r.hilite&&i.set(je(o).key,je(o)),i.set(o.key,o);const s=new Set;let l=n.firstElementChild;for(;l;)s.add(l.getAttribute("cgKey")),l=l.nextElementSibling;for(const[c,a]of i.entries())s.has(c)||n.appendChild(oo(a))}function Ji(e,t,n,r){const i=new Map;for(const o of e)i.set(o.hash,!1);for(const o of[t,n]){const s=[];let l=o.firstElementChild,c;for(;l;)c=l.getAttribute("cgHash"),i.has(c)?i.set(c,!0):s.push(l),l=l.nextElementSibling;for(const a of s)o.removeChild(a)}for(const o of e.filter(s=>!i.get(s.hash)))for(const s of r(o))s.isCustom?n.appendChild(s.el):t.appendChild(s.el)}function Zt({orig:e,dest:t,brush:n,piece:r,modifiers:i,customSvg:o,label:s},l,c,a){var p,m;return[a.width,a.height,c,e,t,n,l&&"-",r&&eo(r),i&&to(i),o&&`custom-${Xt(o.html)},${(m=(p=o.center)===null||p===void 0?void 0:p[0])!==null&&m!==void 0?m:"o"}`,s&&`label-${Xt(s.text)}`].filter(g=>g).join(",")}function eo(e){return[e.color,e.role,e.scale].filter(t=>t).join(",")}function to(e){return[e.lineWidth,e.hilite&&"*"].filter(t=>t).join(",")}function Xt(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n)>>>0;return t.toString()}function no(e,{shape:t,current:n,hash:r},i,o,s){var l,c;const a=Qe(ze(L(t.orig),e.orientation),s),p=t.dest?Qe(ze(L(t.dest),e.orientation),s):a,m=t.brush&&In(i[t.brush],t.modifiers),g=o.get(t.dest),y=[];if(m){const v=Q(R("g"),{cgHash:r});y.push({el:v}),a[0]!==p[0]||a[1]!==p[1]?v.appendChild(io(t,m,a,p,n,dt(t.dest,o))):v.appendChild(ro(i[t.brush],a,n,s))}if(t.label){const v=t.label;(l=v.fill)!==null&&l!==void 0||(v.fill=t.brush&&i[t.brush].color);const _=t.brush?void 0:"tr";y.push({el:so(v,r,a,p,g,_),isCustom:!0})}if(t.customSvg){const v=(c=t.customSvg.center)!==null&&c!==void 0?c:"orig",[_,C]=v==="label"?On(a,p,g).map(K=>K-.5):v==="dest"?p:a,I=Q(R("g"),{transform:`translate(${_},${C})`,cgHash:r});I.innerHTML=`<svg width="1" height="1" viewBox="0 0 100 100">${t.customSvg.html}</svg>`,y.push({el:I,isCustom:!0})}return y}function ro(e,t,n,r){const i=lo(),o=(r.width+r.height)/(4*Math.max(r.width,r.height));return Q(R("circle"),{stroke:e.color,"stroke-width":i[n?0:1],fill:"none",opacity:xn(e,n),cx:t[0],cy:t[1],r:o-i[1]/2})}function je(e){return["#ffffff","#fff","white"].includes(e.color)?Yt.hilitePrimary:Yt.hiliteWhite}function io(e,t,n,r,i,o){var s;function l(p){var m;const g=co(o&&!i),y=r[0]-n[0],v=r[1]-n[1],_=Math.atan2(v,y),C=Math.cos(_)*g,I=Math.sin(_)*g;return Q(R("line"),{stroke:p?je(t).color:t.color,"stroke-width":ao(t,i)+(p?.04:0),"stroke-linecap":"round","marker-end":`url(#arrowhead-${p?je(t).key:t.key})`,opacity:!((m=e.modifiers)===null||m===void 0)&&m.hilite?1:xn(t,i),x1:n[0],y1:n[1],x2:r[0]-C,y2:r[1]-I})}if(!(!((s=e.modifiers)===null||s===void 0)&&s.hilite))return l(!1);const c=R("g"),a=Q(R("g"),{filter:"url(#cg-filter-blur)"});return a.appendChild(uo(n,r)),a.appendChild(l(!0)),c.appendChild(a),c.appendChild(l(!1)),c}function oo(e){const t=Q(R("marker"),{id:"arrowhead-"+e.key,orient:"auto",overflow:"visible",markerWidth:4,markerHeight:4,refX:e.key.startsWith("hilite")?1.86:2.05,refY:2});return t.appendChild(Q(R("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function so(e,t,n,r,i,o){var s;const c=.4*.75**e.text.length,a=On(n,r,i),p=o==="tr"?.4:0,m=Q(R("g"),{transform:`translate(${a[0]+p},${a[1]-p})`,cgHash:t});m.appendChild(Q(R("circle"),{r:.4/2,"fill-opacity":o?1:.8,"stroke-opacity":o?1:.7,"stroke-width":.03,fill:(s=e.fill)!==null&&s!==void 0?s:"#666",stroke:"white"}));const g=Q(R("text"),{"font-size":c,"font-family":"Noto Sans","text-anchor":"middle",fill:"white",y:.13*.75**e.text.length});return g.innerHTML=e.text,m.appendChild(g),m}function ze(e,t){return t==="white"?e:[7-e[0],7-e[1]]}function dt(e,t){return(e&&t.has(e)&&t.get(e).size>1)===!0}function R(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function Q(e,t){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.setAttribute(n,t[n]);return e}function In(e,t){return t?{color:e.color,opacity:Math.round(e.opacity*10)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter(n=>n).join("")}:e}function lo(){return[3/64,4/64]}function ao(e,t){return(e.lineWidth||10)*(t?.85:1)/64}function xn(e,t){return(e.opacity||1)*(t?.9:1)}function co(e){return(e?20:10)/64}function Qe(e,t){const n=Math.min(1,t.width/t.height),r=Math.min(1,t.height/t.width);return[(e[0]-3.5)*n,(3.5-e[1])*r]}function uo(e,t){const n={from:[Math.floor(Math.min(e[0],t[0])),Math.floor(Math.min(e[1],t[1]))],to:[Math.ceil(Math.max(e[0],t[0])),Math.ceil(Math.max(e[1],t[1]))]};return Q(R("rect"),{x:n.from[0],y:n.from[1],width:n.to[0]-n.from[0],height:n.to[1]-n.from[1],fill:"none",stroke:"none"})}function pt(e,t,n=!0){const r=Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI;return n?(Math.round(r*8/Math.PI)+16)%16:r}function fo(e,t){return Math.sqrt([e[0]-t[0],e[1]-t[1]].reduce((n,r)=>n+r*r,0))}function On(e,t,n){let r=fo(e,t);const i=pt(e,t,!1);if(n&&(r-=33/64,n.size>1)){r-=10/64;const o=pt(e,t);(n.has((o+1)%16)||n.has((o+15)%16))&&o&1&&(r-=.4)}return[e[0]-Math.cos(i)*r,e[1]-Math.sin(i)*r].map(o=>o+.5)}function ho(e,t){e.innerHTML="",e.classList.add("cg-wrap");for(const c of ai)e.classList.toggle("orientation-"+c,t.orientation===c);e.classList.toggle("manipulable",!t.viewOnly);const n=se("cg-container");e.appendChild(n);const r=se("cg-board");n.appendChild(r);let i,o,s;if(t.drawable.visible&&(i=Q(R("svg"),{class:"cg-shapes",viewBox:"-4 -4 8 8",preserveAspectRatio:"xMidYMid slice"}),i.appendChild(Yi()),i.appendChild(R("g")),o=Q(R("svg"),{class:"cg-custom-svgs",viewBox:"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"}),o.appendChild(R("g")),s=se("cg-auto-pieces"),n.appendChild(i),n.appendChild(o),n.appendChild(s)),t.coordinates){const c=t.orientation==="black"?" black":"",a=t.ranksPosition==="left"?" left":"";if(t.coordinatesOnSquares){const p=t.orientation==="white"?m=>m+1:m=>8-m;He.forEach((m,g)=>n.appendChild(st(We.map(y=>m+y),"squares rank"+p(g)+c+a)))}else n.appendChild(st(We,"ranks"+c+a)),n.appendChild(st(He,"files"+c))}let l;return t.draggable.enabled&&t.draggable.showGhost&&(l=se("piece","ghost"),vt(l,!1),n.appendChild(l)),{board:r,container:n,wrap:e,ghost:l,svg:i,customSvg:o,autoPieces:s}}function st(e,t){const n=se("coords",t);let r;for(const i of e)r=se("coord"),r.textContent=i,n.appendChild(r);return n}function po(e,t){if(!e.dropmode.active)return;de(e),pe(e);const n=e.dropmode.piece;if(n){e.pieces.set("a0",n);const r=ye(t),i=r&&Se(r,Y(e),e.dom.bounds());i&&bn(e,"a0",i)}e.dom.redraw()}function go(e,t){const n=e.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(t).observe(e.dom.elements.wrap),(e.disableContextMenu||e.drawable.enabled)&&n.addEventListener("contextmenu",i=>i.preventDefault()),e.viewOnly)return;const r=vo(e);n.addEventListener("touchstart",r,{passive:!1}),n.addEventListener("mousedown",r,{passive:!1})}function mo(e,t){const n=[];if("ResizeObserver"in window||n.push($e(document.body,"chessground.resize",t)),!e.viewOnly){const r=Jt(e,Gi,qi),i=Jt(e,ji,Di);for(const s of["touchmove","mousemove"])n.push($e(document,s,r));for(const s of["touchend","mouseup"])n.push($e(document,s,i));const o=()=>e.dom.bounds.clear();n.push($e(document,"scroll",o,{capture:!0,passive:!0})),n.push($e(window,"resize",o,{passive:!0}))}return()=>n.forEach(r=>r())}function $e(e,t,n,r){return e.addEventListener(t,n,r),()=>e.removeEventListener(t,n,r)}const vo=e=>t=>{e.draggable.current?Ge(e):e.drawable.current?Pn(e):t.shiftKey||an(t)?e.drawable.enabled&&Ki(e,t):e.viewOnly||(e.dropmode.active?po(e,t):Ui(e,t))},Jt=(e,t,n)=>r=>{e.drawable.current?e.drawable.enabled&&n(e,r):e.viewOnly||t(e,r)};function bo(e){const t=Y(e),n=Le(e.dom.bounds()),r=e.dom.elements.board,i=e.pieces,o=e.animation.current,s=o?o.plan.anims:new Map,l=o?o.plan.fadings:new Map,c=e.draggable.current,a=wo(e),p=new Set,m=new Set,g=new Map,y=new Map;let v,_,C,I,K,X,le,G,N,U;for(_=r.firstChild;_;){if(v=_.cgKey,Ln(_))if(C=i.get(v),K=s.get(v),X=l.get(v),I=_.cgPiece,_.cgDragging&&(!c||c.orig!==v)&&(_.classList.remove("dragging"),ie(_,n(L(v),t)),_.cgDragging=!1),!X&&_.cgFading&&(_.cgFading=!1,_.classList.remove("fading")),C){if(K&&_.cgAnimating&&I===Me(C)){const T=L(v);T[0]+=K[2],T[1]+=K[3],_.classList.add("anim"),ie(_,n(T,t))}else _.cgAnimating&&(_.cgAnimating=!1,_.classList.remove("anim"),ie(_,n(L(v),t)),e.addPieceZIndex&&(_.style.zIndex=lt(L(v),t)));I===Me(C)&&(!X||!_.cgFading)?p.add(v):X&&I===Me(X)?(_.classList.add("fading"),_.cgFading=!0):at(g,I,_)}else at(g,I,_);else if(Nn(_)){const T=_.className;a.get(v)===T?m.add(v):at(y,T,_)}_=_.nextSibling}for(const[T,w]of a)if(!m.has(T)){N=y.get(w),U=N&&N.pop();const S=n(L(T),t);if(U)U.cgKey=T,ie(U,S);else{const x=se("square",w);x.cgKey=T,ie(x,S),r.insertBefore(x,r.firstChild)}}for(const[T,w]of i)if(K=s.get(T),!p.has(T))if(le=g.get(Me(w)),G=le&&le.pop(),G){G.cgKey=T,G.cgFading&&(G.classList.remove("fading"),G.cgFading=!1);const S=L(T);e.addPieceZIndex&&(G.style.zIndex=lt(S,t)),K&&(G.cgAnimating=!0,G.classList.add("anim"),S[0]+=K[2],S[1]+=K[3]),ie(G,n(S,t))}else{const S=Me(w),x=se("piece",S),j=L(T);x.cgPiece=S,x.cgKey=T,K&&(x.cgAnimating=!0,j[0]+=K[2],j[1]+=K[3]),ie(x,n(j,t)),e.addPieceZIndex&&(x.style.zIndex=lt(j,t)),r.appendChild(x)}for(const T of g.values())tn(e,T);for(const T of y.values())tn(e,T)}function _o(e){const t=Y(e),n=Le(e.dom.bounds());let r=e.dom.elements.board.firstChild;for(;r;)(Ln(r)&&!r.cgAnimating||Nn(r))&&ie(r,n(L(r.cgKey),t)),r=r.nextSibling}function en(e){var t,n;const r=e.dom.elements.wrap.getBoundingClientRect(),i=e.dom.elements.container,o=r.height/r.width,s=Math.floor(r.width*window.devicePixelRatio/8)*8/window.devicePixelRatio,l=s*o;i.style.width=s+"px",i.style.height=l+"px",e.dom.bounds.clear(),(t=e.addDimensionsCssVarsTo)===null||t===void 0||t.style.setProperty("---cg-width",s+"px"),(n=e.addDimensionsCssVarsTo)===null||n===void 0||n.style.setProperty("---cg-height",l+"px")}const Ln=e=>e.tagName==="PIECE",Nn=e=>e.tagName==="SQUARE";function tn(e,t){for(const n of t)e.dom.elements.board.removeChild(n)}function lt(e,t){const r=e[1];return`${t?10-r:3+r}`}const Me=e=>`${e.color} ${e.role}`;function wo(e){var t,n,r;const i=new Map;if(e.lastMove&&e.highlight.lastMove)for(const l of e.lastMove)oe(i,l,"last-move");if(e.check&&e.highlight.check&&oe(i,e.check,"check"),e.selected&&(oe(i,e.selected,"selected"),e.movable.showDests)){const l=(t=e.movable.dests)===null||t===void 0?void 0:t.get(e.selected);if(l)for(const a of l)oe(i,a,"move-dest"+(e.pieces.has(a)?" oc":""));const c=(r=(n=e.premovable.customDests)===null||n===void 0?void 0:n.get(e.selected))!==null&&r!==void 0?r:e.premovable.dests;if(c)for(const a of c)oe(i,a,"premove-dest"+(e.pieces.has(a)?" oc":""))}const o=e.premovable.current;if(o)for(const l of o)oe(i,l,"current-premove");else e.predroppable.current&&oe(i,e.predroppable.current.key,"current-premove");const s=e.exploding;if(s)for(const l of s.keys)oe(i,l,"exploding"+s.stage);return e.highlight.custom&&e.highlight.custom.forEach((l,c)=>{oe(i,c,l)}),i}function oe(e,t,n){const r=e.get(t);r?e.set(t,`${r} ${n}`):e.set(t,n)}function at(e,t,n){const r=e.get(t);r?r.push(n):e.set(t,[n])}function yo(e,t,n){const r=new Map,i=[];for(const l of e)r.set(l.hash,!1);let o=t.firstElementChild,s;for(;o;)s=o.getAttribute("cgHash"),r.has(s)?r.set(s,!0):i.push(o),o=o.nextElementSibling;for(const l of i)t.removeChild(l);for(const l of e)r.get(l.hash)||t.appendChild(n(l))}function So(e,t){const r=e.drawable.autoShapes.filter(i=>i.piece).map(i=>({shape:i,hash:Eo(i),current:!1}));yo(r,t,i=>ko(e,i,e.dom.bounds()))}function Co(e){var t;const n=Y(e),r=Le(e.dom.bounds());let i=(t=e.dom.elements.autoPieces)===null||t===void 0?void 0:t.firstChild;for(;i;)ln(i,r(L(i.cgKey),n),i.cgScale),i=i.nextSibling}function ko(e,{shape:t,hash:n},r){var i,o,s;const l=t.orig,c=(i=t.piece)===null||i===void 0?void 0:i.role,a=(o=t.piece)===null||o===void 0?void 0:o.color,p=(s=t.piece)===null||s===void 0?void 0:s.scale,m=se("piece",`${c} ${a}`);return m.setAttribute("cgHash",n),m.cgKey=l,m.cgScale=p,ln(m,Le(r)(L(l),Y(e)),p),m}const Eo=e=>{var t,n,r;return[e.orig,(t=e.piece)===null||t===void 0?void 0:t.role,(n=e.piece)===null||n===void 0?void 0:n.color,(r=e.piece)===null||r===void 0?void 0:r.scale].join(",")};function Ao(e,t){const n=Vi();kn(n,t||{});function r(){const i="dom"in n?n.dom.unbind:void 0,o=ho(e,n),s=ui(()=>o.board.getBoundingClientRect()),l=p=>{bo(a),o.autoPieces&&So(a,o.autoPieces),!p&&o.svg&&Zi(a,o.svg,o.customSvg)},c=()=>{en(a),_o(a),o.autoPieces&&Co(a)},a=n;return a.dom={elements:o,bounds:s,redraw:Po(l),redrawNow:l,unbind:i},a.drawable.prevSvgHash="",en(a),l(!1),go(a,c),i||(a.dom.unbind=mo(a,c)),a.events.insert&&a.events.insert(o),a}return Qi(r(),r)}function Po(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame(()=>{e(),t=!1}))}}const nn={PIECE_SET:"chess_piece_set",THEME:"chess_theme",DIFFICULTY:"chess_difficulty",GAME_STATE:"chess_game_state"};function $o(e,t){try{localStorage.setItem(e,typeof t=="string"?t:JSON.stringify(t))}catch(n){console.error(`Error saving to localStorage for key "${e}":`,n)}}function Mo(e,t=null){try{const n=localStorage.getItem(e);if(n===null)return t;try{return JSON.parse(n)}catch{return n}}catch(n){return console.error(`Error retrieving from localStorage for key "${e}":`,n),t}}class To{constructor(){this.selectedSet=Mo(nn.PIECE_SET,"cburnett")}getSelectedSet(){return this.selectedSet}async loadSet(t){try{if(!/^[a-zA-Z0-9_-]+$/.test(t))return console.error(`Invalid piece set name: ${t}`),null;const n=["wK","wQ","wR","wB","wN","wP","bK","bQ","bR","bB","bN","bP"],r={};for(const i of n)r[i]=`/pieces/${t}/${i}.svg`;return this.selectedSet=t,$o(nn.PIECE_SET,t),r}catch(n){return console.error(`Failed to load piece set "${t}":`,n),null}}}class Io{constructor(t,n={}){if(!t)throw new Error("Board container element not provided for ChessUI.");this.boardContainer=t,this.onUserMove=n.onUserMove||(()=>{}),this.gameInstance=null,this.pieceManager=new To,this.ground=Ao(t,{movable:{color:"white",free:!1,dests:new Map,showDests:!0},events:{move:(r,i,o)=>{this.onUserMove(r,i)},select:r=>{this.gameInstance&&this.showLegalMovesForPiece(this.gameInstance,r)}},orientation:"white",turnColor:"white",check:null,lastMove:null}),t.classList.add("is2d"),this.loadInitialPieceSet()}calculateLegalDests(t){if(!t)return new Map;const n=new Map;return t.getAllLegalMoves().forEach(i=>{n.has(i.from)||n.set(i.from,[]),n.get(i.from).push(i.to)}),n}updateBoard(t){if(!t)return;this.gameInstance=t;const n=t.getFen(),r=t.getTurn(),i=t.getGameStatus(),o=t.chess.history({verbose:!0}).slice(-1)[0],s=o?[o.from,o.to]:null,l=this.calculateLegalDests(t);this.ground.set({fen:n,turnColor:r==="w"?"white":"black",movable:{color:r==="w"?"white":"black",dests:l,free:!1,showDests:!0},check:i.isCheck?this.findKing(t,r):null,lastMove:s})}findKing(t,n){if(!t)return null;const r=t.chess.board();for(let i=0;i<r.length;i++)for(let o=0;o<r[i].length;o++){const s=r[i][o];if(s&&s.type==="k"&&s.color===n)return`${String.fromCharCode(97+o)}${8-i}`}return null}flipBoard(){const t=this.ground.state.orientation;this.ground.set({orientation:t==="white"?"black":"white"})}setOnUserMove(t){this.onUserMove=t}showLegalMovesForPiece(t,n){if(!t||!n)return;const r=t.getPiece(n);!r||r.color!==t.getTurn()||t.getLegalMoves(n)}setTheme(t){var r;console.log(` UI: Changing theme to: ${t}`),console.log(" UI: Board container:",this.boardContainer);let n=this.boardContainer.querySelector(".cg-wrap");if(n||(n=this.boardContainer.querySelector("cg-board")),n||(n=this.boardContainer.querySelector('[class*="cg-"]')),n||(n=this.boardContainer),console.log(" UI: Found target element:",n),console.log(" UI: Element classes:",(r=n==null?void 0:n.classList)==null?void 0:r.toString()),n){const i=["brown","blue","green","light","dark"];console.log(` UI: Before removing - classes: ${n.classList.toString()}`),i.forEach(o=>n.classList.remove(o)),console.log(` UI: After removing - classes: ${n.classList.toString()}`),n.classList.add(t),console.log(` UI: Theme ${t} applied to chessboard.`),console.log(` UI: Final classes: ${n.classList.toString()}`),setTimeout(()=>{console.log(` UI: Forcing redraw for theme ${t}`),this.ground.redrawAll()},50)}else console.error(" No suitable element found for theme switching."),console.log(" UI: Board container HTML:",this.boardContainer.innerHTML)}async setPieceStyle(t){console.log(` UI: Attempting to set piece style to: ${t}`);try{await this.loadPieceCSS(t),await this.pieceManager.loadSet(t),console.log(` UI: Piece style successfully set to ${t}.`)}catch(n){console.error(` UI: Error setting piece style to ${t}:`,n)}}async loadPieceCSS(t){console.log(` Loading piece CSS for: ${t}`);const n=document.querySelectorAll("link[data-piece-style]");console.log(` Removing ${n.length} existing piece CSS links`),n.forEach(i=>i.remove());const r=document.createElement("link");return r.rel="stylesheet",r.href=`/chess-pwa/piece-css/${t}.css`,r.setAttribute("data-piece-style",t),console.log(` Loading CSS from: ${r.href}`),console.log(" BASE_URL is: /chess-pwa/"),new Promise((i,o)=>{const s=setTimeout(()=>{console.warn(` Timeout loading piece CSS: ${t}`),i()},5e3);r.onload=()=>{clearTimeout(s),console.log(` Successfully loaded piece CSS: ${t}`),setTimeout(()=>{this.ground.redrawAll()},100),i()},r.onerror=()=>{clearTimeout(s),console.error(` Failed to load piece CSS: ${t} from ${r.href}`),console.log(" Falling back to default pieces"),i()},document.head.appendChild(r)})}async loadInitialPieceSet(){const t=this.pieceManager.getSelectedSet()||"cburnett";console.log(`UI: Loading initial piece set: ${t}`),await this.setPieceStyle(t)}}let he,ve=null,Ie=null;function xo(e,t){ve=e,Ie=t,he=new Worker(new URL("/chess-pwa/assets/stockfish-worker-9EnxOfdj.js",import.meta.url)),console.log("Sending init message to worker"),console.log("Stockfish worker initialized"),he.onmessage=r=>{const i=r.data;if(i&&i.type==="ready")ve&&ve();else if(typeof i=="string"){if(i.startsWith("bestmove ")){const o=i.split(" ");o.length>=2&&Ie&&Ie(o[1])}}else i&&i.type==="error"&&(console.error("AI Worker Error:",i.message),ve&&ve(new Error(i.message||"AI initialization failed")))},he.onerror=r=>{console.error("AI Worker encountered a critical error:",r),ve&&ve(r)};const n="/chess-pwa/";console.log("AI: Sending baseUrl to worker:",n),he.postMessage({type:"init",baseUrl:n})}function rn(e,t){if(he){let n=1,r="go depth 5";switch(t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()){case"Easy":n=1,r="go depth 3 movetime 500";break;case"Medium":n=5,r="go depth 8 movetime 1000";break;case"Hard":n=10,r="go depth 12 movetime 1500";break;case"Expert":n=15,r="go depth 15 movetime 2000";break;default:console.warn(`Unknown difficulty: ${t}, using Easy settings.`),n=1,r="go depth 3 movetime 500"}he.postMessage({type:"setoption",name:"Skill Level",value:n}),he.postMessage({type:"position",fen:e}),he.postMessage({type:"go",command:r})}else console.error("AI Worker not available to request move."),Ie&&Ie(null,new Error("AI worker not available"))}document.addEventListener("DOMContentLoaded",()=>{const e=new li,t=document.getElementById("board-container"),n=document.getElementById("status-bar"),r=document.getElementById("history-content"),i=document.getElementById("new-game-btn"),o=document.getElementById("undo-btn"),s=document.getElementById("flip-board-btn"),l=document.getElementById("theme-selector"),c=document.getElementById("piece-style-selector"),a=document.getElementById("difficulty-selector"),p=document.getElementById("sound-enabled"),m=document.getElementById("test-sound-btn");let g=!1,y="Medium",v="w",_=!1,C=null,I=!1;function K(){if(I)return!0;try{return C=new(window.AudioContext||window.webkitAudioContext),I=!0,console.log(" Audio context initialized"),!0}catch(w){return console.log(" Audio not supported:",w),!1}}function X(){if(!(!p||!p.checked)&&!(!I&&!K()))try{C.state==="suspended"&&C.resume();const w=C.createOscillator(),S=C.createGain();w.connect(S),S.connect(C.destination),w.frequency.setValueAtTime(800,C.currentTime),S.gain.setValueAtTime(.15,C.currentTime),S.gain.exponentialRampToValueAtTime(.01,C.currentTime+.15),w.start(C.currentTime),w.stop(C.currentTime+.15),console.log(" Move sound played")}catch(w){console.log(" Error playing sound:",w)}}function le(){if(!(!p||!p.checked)){if(!I&&!K()){alert("Audio not supported on this device");return}try{C.state==="suspended"&&C.resume();const w=C.createOscillator(),S=C.createGain();w.connect(S),S.connect(C.destination),w.frequency.setValueAtTime(600,C.currentTime),S.gain.setValueAtTime(.1,C.currentTime),S.gain.exponentialRampToValueAtTime(.01,C.currentTime+.2),w.start(C.currentTime),w.stop(C.currentTime+.2),console.log(" Test sound played")}catch(w){console.log(" Error playing test sound:",w)}}}if(!t){console.error("Board container element (#board-container) not found. Chess UI cannot be initialized.");return}n||console.warn("Status bar element (#status-bar) not found. Game status will not be displayed."),a&&(a.disabled=!0,y=a.value||"Medium");const G=(w,S)=>{if(e.getTurn()!==v&&g){console.log("Not player's turn or AI is active and it's AI's turn.");return}if(e.makeMove({from:w,to:S})){N.updateBoard(e),X(),U();const j=e.getGameStatus();g&&!j.isGameOver&&e.getTurn()!==v&&_?(n.textContent="AI is thinking...",N.ground.set({viewOnly:!0}),setTimeout(()=>{rn(e.getFen(),y)},500)):j.isGameOver&&U()}else console.warn("Invalid move attempted by user:",{from:w,to:S})},N=new Io(t,{onUserMove:G});xo(w=>{w?(console.error("AI failed to initialize:",w),n&&(n.textContent="AI opponent failed to load. Playing locally."),_=!1,g=!1,a&&(a.disabled=!0)):(console.log("AI initialized successfully."),_=!0,g=!0,a&&(a.disabled=!1,y=a.value),n&&(n.textContent="AI ready. Player's turn."),U())},w=>{if(N.ground.set({viewOnly:!1}),w){console.log("AI move received:",w);const S=w.substring(0,2),x=w.substring(2,4);let j;w.length===5&&(j=w.substring(4)),e.makeMove({from:S,to:x,promotion:j})?(N.updateBoard(e),X()):(console.error("AI made an invalid move:",w),n&&(n.textContent="AI error. Please undo or restart."))}else console.warn("AI returned no move or an error."),n&&(n.textContent="AI is thinking or encountered an issue...");U()});function U(){if(!n)return;const w=e.getGameStatus();let S="";w.isCheckmate?S=` Checkmate! ${w.turn===v?"AI":"Player"} wins.`:w.isStalemate?S=" Stalemate. Game is a draw.":w.isDraw?S=" Draw by rule (50-move, threefold repetition, or insufficient material).":(g&&e.getTurn()!==v&&!w.isGameOver&&_?S=" AI is thinking...":g&&e.getTurn()===v&&!w.isGameOver&&_?S=` Player (${v==="w"?"White":"Black"}) to move.`:g?S=" Game starting or AI initializing...":S=`${w.turn==="w"?" White":" Black"} to move.`,w.isCheck&&(g&&e.getTurn()===v||!g)&&(S+="  Check!")),n.textContent=S,T()}function T(){if(!r)return;const w=e.chess.history();if(w.length===0){r.textContent="No moves yet.";return}let S="";for(let x=0;x<w.length;x+=2){const j=x/2+1,Ne=w[x],Ee=w[x+1];S+=`${j}. ${Ne}`,Ee&&(S+=` ${Ee}`),S+=`
`}r.textContent=S.trim(),r.scrollTop=r.scrollHeight}i&&i.addEventListener("click",()=>{e.resetGame(),v="w",N.ground.set({orientation:"white",viewOnly:!1}),N.updateBoard(e),U(),console.log("New game started. Player as White.")}),o&&o.addEventListener("click",()=>{let w=0;g?e.getTurn()!==v&&e.chess.history().length>0?w=1:e.getTurn()===v&&e.chess.history().length>=2?w=2:e.chess.history().length>0&&(w=1):e.chess.history().length>0&&(w=1);for(let x=0;x<w;x++)e.undoMove();N.updateBoard(e),U(),N.ground.set({viewOnly:!1});const S=e.getGameStatus();g&&!S.isGameOver&&e.getTurn()!==v&&_&&(n.textContent="AI is thinking...",N.ground.set({viewOnly:!0}),setTimeout(()=>{rn(e.getFen(),y)},500))}),s&&s.addEventListener("click",()=>{N.flipBoard(),console.log("Board flipped.")}),l&&l.addEventListener("change",w=>{const S=w.target.value;console.log(" Theme changed to:",S),N.setTheme(S),n&&(n.textContent=` Theme changed to ${S.charAt(0).toUpperCase()+S.slice(1)}`,setTimeout(()=>{U()},2e3)),l.style.background="#f0f8e8",setTimeout(()=>{l.style.background=""},1e3)}),c&&c.addEventListener("change",async w=>{const S=w.target.value;console.log(" Piece style changed to:",S),n&&(n.textContent=` Loading ${S} pieces...`),await N.setPieceStyle(S),N.updateBoard(e),n&&(n.textContent=` Pieces changed to ${S.charAt(0).toUpperCase()+S.slice(1)}`,setTimeout(()=>{U()},2e3)),c.style.background="#fff0e6",setTimeout(()=>{c.style.background=""},1e3)}),a&&(y=a.value||"medium",console.log(`Initial difficulty set to: ${y}`),a.addEventListener("change",w=>{if(y=w.target.value,console.log(" Difficulty changed to:",y),n){const S={easy:"Easy (Level 1)",medium:"Medium (Level 5)",hard:"Hard (Level 10)",expert:"Expert (Level 15)"};n.textContent=` Difficulty set to ${S[y]||y}`,setTimeout(()=>{U()},3e3)}a.style.background="#e6f3ff",setTimeout(()=>{a.style.background=""},1e3)})),m&&m.addEventListener("click",()=>{console.log(" Test sound button clicked"),le()}),N.loadInitialPieceSet().then(()=>{N.updateBoard(e),U(),console.log("Chess PWA main.js initialized with AI integration attempt.")})});
